(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{4:function(t,e){},"4fRq":function(t,e){var i="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(i){var n=new Uint8Array(16);t.exports=function(){return i(n),n}}else{var r=new Array(16);t.exports=function(){for(var t,e=0;e<16;e++)0==(3&e)&&(t=4294967296*Math.random()),r[e]=t>>>((3&e)<<3)&255;return r}}},"6ZY7":function(t,e,i){"use strict";i.r(e);var n=i("8Y7J");class r{}var s=i("pMnS"),o=i("s7LF"),a=i("SVse"),l=i("lJxs"),u=i("XS3J"),c=i("LRne");let h=(()=>{class t{constructor(t,e){this.dbName=t,this.collName=e,this.db=new u(t,{autoload:!0,autosave:!0,autosaveInterval:1e4}),this.databaseInit()}databaseInit(){this.db.loadDatabase(),this.db.getCollection(this.collName)||this.db.addCollection(this.collName)}getAll(){return Object(c.a)(this.db.getCollection(this.collName).data)}getById(t){const e=this.db.getCollection(this.collName);return Object(c.a)(e.findOne({id:t}))}update(t){const e=this.db.getCollection(this.collName);let i=e.findOne({id:t.id});return i=Object.assign({},i,t),e.update(i),this.db.saveDatabase(this.collName),Object(c.a)(i)}delete(t){return this.db.getCollection(this.collName).findAndRemove({id:t}),this.db.saveDatabase(this.collName),Object(c.a)({})}deleteEntity(t){return this.db.getCollection(this.collName).findAndRemove(t),this.db.saveDatabase(this.collName),Object(c.a)({})}insert(t){return this.db.getCollection(this.collName).insert(t),this.db.saveDatabase(this.collName),Object(c.a)(t)}}return t.ngInjectableDef=n.Mb({factory:function(){return new t(n.Nb("dbName"),n.Nb("collName"))},token:t,providedIn:"root"}),t})();const d={dbName:"mydb.json",entities:{customers:"customers"}};var p=i("EcEN"),f=i.n(p);let y=(()=>{class t extends h{constructor(){super(d.dbName,d.entities.customers);const t=this.db.getCollection(d.entities.customers);0===t.data.length&&t.insert([{id:f()(),firstName:"John",lastName:"Doh",address:"123 Main St."},{id:f()(),firstName:"Sue",lastName:"Miller",address:"49 E 4th St."},{id:f()(),firstName:"Henry",lastName:"Block",address:"88992 Cutter Lane"},{id:f()(),firstName:"Alice",lastName:"Morey",address:"182 S Wilson Way"}])}}return t.ngInjectableDef=n.Mb({factory:function(){return new t},token:t,providedIn:"root"}),t})();class v{constructor(t,e){this.customerService=t,this.fb=e}ngOnInit(){this.loadCustomers(),this.initForm(this.customer)}initForm(t){this.form=this.fb.group({id:[t?t.id:0],firstName:[t?t.firstName:""],lastName:[t?t.lastName:""],address:[t?t.address:""]})}loadCustomers(){this.customers$=this.customerService.getAll().pipe(Object(l.a)(t=>t))}selectedCustomer(t){this.customerService.getById(t.target.value).subscribe(t=>{t&&(this.initForm(t),this.selected=!0)})}addNew(){this.initForm(),this.selected=!0}delete(){confirm("Are you sure you want to delete this customer?")&&this.customerService.delete(this.form.value.id).subscribe(()=>{this.loadCustomers(),this.selected=!1})}save(){const t=this.form.value;0===t.id?(t.id=f()(),this.customerService.insert(t).subscribe(t=>{this.loadCustomers(),this.selected=!1})):this.customerService.update(t).subscribe(t=>{t&&(this.loadCustomers(),this.selected=!1)})}}var g=n.nb({encapsulation:0,styles:[[""]],data:{}});function b(t){return n.Ib(0,[(t()(),n.pb(0,0,null,null,3,"option",[],null,[[null,"click"]],(function(t,e,i){var n=!0;return"click"===e&&(n=!1!==t.component.selectedCustomer(i)&&n),n}),null,null)),n.ob(1,147456,null,0,o.m,[n.k,n.B,[8,null]],{value:[0,"value"]},null),n.ob(2,147456,null,0,o.r,[n.k,n.B,[8,null]],{value:[0,"value"]},null),(t()(),n.Gb(3,null,[""," ",""]))],(function(t,e){t(e,1,0,e.context.$implicit.id),t(e,2,0,e.context.$implicit.id)}),(function(t,e){t(e,3,0,e.context.$implicit.firstName,e.context.$implicit.lastName)}))}function m(t){return n.Ib(0,[(t()(),n.pb(0,0,null,null,41,"div",[["class","col-xl-9"]],null,null,null,null,null)),(t()(),n.pb(1,0,null,null,40,"form",[["novalidate",""]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],[[null,"submit"],[null,"reset"]],(function(t,e,i){var r=!0;return"submit"===e&&(r=!1!==n.Ab(t,3).onSubmit(i)&&r),"reset"===e&&(r=!1!==n.Ab(t,3).onReset()&&r),r}),null,null)),n.ob(2,16384,null,0,o.s,[],null,null),n.ob(3,540672,null,0,o.f,[[8,null],[8,null]],{form:[0,"form"]},null),n.Db(2048,null,o.b,null,[o.f]),n.ob(5,16384,null,0,o.k,[[4,o.b]],null,null),(t()(),n.pb(6,0,null,null,9,"div",[["class","form-group row"]],null,null,null,null,null)),(t()(),n.pb(7,0,null,null,1,"label",[["class","col-sm-2"],["for","firstName"]],null,null,null,null,null)),(t()(),n.Gb(-1,null,["First Name:"])),(t()(),n.pb(9,0,null,null,6,"div",[["class","col-sm-10"]],null,null,null,null,null)),(t()(),n.pb(10,0,null,null,5,"input",[["class","form-control"],["formControlName","firstName"],["type","text"]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],[[null,"input"],[null,"blur"],[null,"compositionstart"],[null,"compositionend"]],(function(t,e,i){var r=!0;return"input"===e&&(r=!1!==n.Ab(t,11)._handleInput(i.target.value)&&r),"blur"===e&&(r=!1!==n.Ab(t,11).onTouched()&&r),"compositionstart"===e&&(r=!1!==n.Ab(t,11)._compositionStart()&&r),"compositionend"===e&&(r=!1!==n.Ab(t,11)._compositionEnd(i.target.value)&&r),r}),null,null)),n.ob(11,16384,null,0,o.c,[n.B,n.k,[2,o.a]],null,null),n.Db(1024,null,o.h,(function(t){return[t]}),[o.c]),n.ob(13,671744,null,0,o.e,[[3,o.b],[8,null],[8,null],[6,o.h],[2,o.q]],{name:[0,"name"]},null),n.Db(2048,null,o.i,null,[o.e]),n.ob(15,16384,null,0,o.j,[[4,o.i]],null,null),(t()(),n.pb(16,0,null,null,9,"div",[["class","form-group row"]],null,null,null,null,null)),(t()(),n.pb(17,0,null,null,1,"label",[["class","col-sm-2"],["for","lastName"]],null,null,null,null,null)),(t()(),n.Gb(-1,null,["Last Name:"])),(t()(),n.pb(19,0,null,null,6,"div",[["class","col-sm-10"]],null,null,null,null,null)),(t()(),n.pb(20,0,null,null,5,"input",[["class","form-control"],["formControlName","lastName"],["type","text"]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],[[null,"input"],[null,"blur"],[null,"compositionstart"],[null,"compositionend"]],(function(t,e,i){var r=!0;return"input"===e&&(r=!1!==n.Ab(t,21)._handleInput(i.target.value)&&r),"blur"===e&&(r=!1!==n.Ab(t,21).onTouched()&&r),"compositionstart"===e&&(r=!1!==n.Ab(t,21)._compositionStart()&&r),"compositionend"===e&&(r=!1!==n.Ab(t,21)._compositionEnd(i.target.value)&&r),r}),null,null)),n.ob(21,16384,null,0,o.c,[n.B,n.k,[2,o.a]],null,null),n.Db(1024,null,o.h,(function(t){return[t]}),[o.c]),n.ob(23,671744,null,0,o.e,[[3,o.b],[8,null],[8,null],[6,o.h],[2,o.q]],{name:[0,"name"]},null),n.Db(2048,null,o.i,null,[o.e]),n.ob(25,16384,null,0,o.j,[[4,o.i]],null,null),(t()(),n.pb(26,0,null,null,9,"div",[["class","form-group row"]],null,null,null,null,null)),(t()(),n.pb(27,0,null,null,1,"label",[["class","col-sm-2"],["for","address"]],null,null,null,null,null)),(t()(),n.Gb(-1,null,["Address:"])),(t()(),n.pb(29,0,null,null,6,"div",[["class","col-sm-10"]],null,null,null,null,null)),(t()(),n.pb(30,0,null,null,5,"input",[["class","form-control"],["formControlName","address"],["type","text"]],[[2,"ng-untouched",null],[2,"ng-touched",null],[2,"ng-pristine",null],[2,"ng-dirty",null],[2,"ng-valid",null],[2,"ng-invalid",null],[2,"ng-pending",null]],[[null,"input"],[null,"blur"],[null,"compositionstart"],[null,"compositionend"]],(function(t,e,i){var r=!0;return"input"===e&&(r=!1!==n.Ab(t,31)._handleInput(i.target.value)&&r),"blur"===e&&(r=!1!==n.Ab(t,31).onTouched()&&r),"compositionstart"===e&&(r=!1!==n.Ab(t,31)._compositionStart()&&r),"compositionend"===e&&(r=!1!==n.Ab(t,31)._compositionEnd(i.target.value)&&r),r}),null,null)),n.ob(31,16384,null,0,o.c,[n.B,n.k,[2,o.a]],null,null),n.Db(1024,null,o.h,(function(t){return[t]}),[o.c]),n.ob(33,671744,null,0,o.e,[[3,o.b],[8,null],[8,null],[6,o.h],[2,o.q]],{name:[0,"name"]},null),n.Db(2048,null,o.i,null,[o.e]),n.ob(35,16384,null,0,o.j,[[4,o.i]],null,null),(t()(),n.pb(36,0,null,null,5,"div",[["class","form-group row"]],null,null,null,null,null)),(t()(),n.pb(37,0,null,null,4,"div",[["class","col-sm-12"]],null,null,null,null,null)),(t()(),n.pb(38,0,null,null,1,"button",[["class","btn btn-primary"],["type","button"]],null,[[null,"click"]],(function(t,e,i){var n=!0;return"click"===e&&(n=!1!==t.component.save()&&n),n}),null,null)),(t()(),n.Gb(-1,null,["Save"])),(t()(),n.pb(40,0,null,null,1,"button",[["class","btn btn-light"],["type","button"]],null,[[null,"click"]],(function(t,e,i){var n=!0;return"click"===e&&(n=!1!==t.component.delete()&&n),n}),null,null)),(t()(),n.Gb(-1,null,["Delete"]))],(function(t,e){t(e,3,0,e.component.form),t(e,13,0,"firstName"),t(e,23,0,"lastName"),t(e,33,0,"address")}),(function(t,e){t(e,1,0,n.Ab(e,5).ngClassUntouched,n.Ab(e,5).ngClassTouched,n.Ab(e,5).ngClassPristine,n.Ab(e,5).ngClassDirty,n.Ab(e,5).ngClassValid,n.Ab(e,5).ngClassInvalid,n.Ab(e,5).ngClassPending),t(e,10,0,n.Ab(e,15).ngClassUntouched,n.Ab(e,15).ngClassTouched,n.Ab(e,15).ngClassPristine,n.Ab(e,15).ngClassDirty,n.Ab(e,15).ngClassValid,n.Ab(e,15).ngClassInvalid,n.Ab(e,15).ngClassPending),t(e,20,0,n.Ab(e,25).ngClassUntouched,n.Ab(e,25).ngClassTouched,n.Ab(e,25).ngClassPristine,n.Ab(e,25).ngClassDirty,n.Ab(e,25).ngClassValid,n.Ab(e,25).ngClassInvalid,n.Ab(e,25).ngClassPending),t(e,30,0,n.Ab(e,35).ngClassUntouched,n.Ab(e,35).ngClassTouched,n.Ab(e,35).ngClassPristine,n.Ab(e,35).ngClassDirty,n.Ab(e,35).ngClassValid,n.Ab(e,35).ngClassInvalid,n.Ab(e,35).ngClassPending)}))}function w(t){return n.Ib(0,[(t()(),n.pb(0,0,null,null,1,"h2",[],null,null,null,null,null)),(t()(),n.Gb(-1,null,["Customers"])),(t()(),n.pb(2,0,null,null,1,"p",[],null,null,null,null,null)),(t()(),n.Gb(-1,null,["The customers are loaded from an LokiJs in-memory database. This is a full CRUD demo."])),(t()(),n.pb(4,0,null,null,10,"div",[["class","container-fluid"]],null,null,null,null,null)),(t()(),n.pb(5,0,null,null,9,"div",[["class","row"]],null,null,null,null,null)),(t()(),n.pb(6,0,null,null,6,"div",[["class","col-xl-3"]],null,null,null,null,null)),(t()(),n.pb(7,0,null,null,1,"button",[["class","btn btn-info"]],null,[[null,"click"]],(function(t,e,i){var n=!0;return"click"===e&&(n=!1!==t.component.addNew()&&n),n}),null,null)),(t()(),n.Gb(-1,null,["Add New"])),(t()(),n.pb(9,0,null,null,3,"select",[["class","form-control"],["size","10"]],null,null,null,null,null)),(t()(),n.eb(16777216,null,null,2,null,b)),n.ob(11,278528,null,0,a.i,[n.M,n.J,n.q],{ngForOf:[0,"ngForOf"]},null),n.Cb(131072,a.b,[n.h]),(t()(),n.eb(16777216,null,null,1,null,m)),n.ob(14,16384,null,0,a.j,[n.M,n.J],{ngIf:[0,"ngIf"]},null)],(function(t,e){var i=e.component;t(e,11,0,n.Hb(e,11,0,n.Ab(e,12).transform(i.customers$))),t(e,14,0,i.selected)}),null)}function I(t){return n.Ib(0,[(t()(),n.pb(0,0,null,null,1,"app-customers",[],null,null,null,w,g)),n.ob(1,114688,null,0,v,[y,o.d],null,null)],(function(t,e){t(e,1,0)}),null)}var O=n.lb("app-customers",v,I,{},{},[]),x=i("iInd");class k{}i.d(e,"CustomersModuleNgFactory",(function(){return A}));var A=n.mb(r,[],(function(t){return n.xb([n.yb(512,n.j,n.X,[[8,[s.a,O]],[3,n.j],n.v]),n.yb(4608,a.l,a.k,[n.s,[2,a.r]]),n.yb(4608,o.p,o.p,[]),n.yb(4608,o.d,o.d,[]),n.yb(1073742336,a.c,a.c,[]),n.yb(1073742336,o.o,o.o,[]),n.yb(1073742336,o.g,o.g,[]),n.yb(1073742336,o.n,o.n,[]),n.yb(1073742336,x.m,x.m,[[2,x.r],[2,x.k]]),n.yb(1073742336,k,k,[]),n.yb(1073742336,r,r,[]),n.yb(1024,x.i,(function(){return[[{path:"",component:v}]]}),[])])}))},EcEN:function(t,e,i){var n=i("xDdU"),r=i("xk4V"),s=r;s.v1=n,s.v4=r,t.exports=s},I2ZF:function(t,e){for(var i=[],n=0;n<256;++n)i[n]=(n+256).toString(16).substr(1);t.exports=function(t,e){var n=e||0;return[i[t[n++]],i[t[n++]],i[t[n++]],i[t[n++]],"-",i[t[n++]],i[t[n++]],"-",i[t[n++]],i[t[n++]],"-",i[t[n++]],i[t[n++]],"-",i[t[n++]],i[t[n++]],i[t[n++]],i[t[n++]],i[t[n++]],i[t[n++]]].join("")}},XS3J:function(t,e,i){var n,r;void 0===(r="function"==typeof(n=function(){return function(){"use strict";var t=Object.prototype.hasOwnProperty,e={copyProperties:function(t,e){var i;for(i in t)e[i]=t[i]},resolveTransformObject:function(t,i,n){var r,s;if("number"!=typeof n&&(n=0),++n>=10)return t;for(r in t)"string"==typeof t[r]&&0===t[r].indexOf("[%lktxp]")?(s=t[r].substring(8),i.hasOwnProperty(s)&&(t[r]=i[s])):"object"==typeof t[r]&&(t[r]=e.resolveTransformObject(t[r],i,n));return t},resolveTransformParams:function(t,i){var n,r,s=[];if(void 0===i)return t;for(n=0;n<t.length;n++)r=p(t[n],"shallow-recurse-objects"),s.push(e.resolveTransformObject(r,i));return s},getIn:function(t,e,i){if(null!=t){if(!i)return t[e];if("string"==typeof e&&(e=e.split(".")),!Array.isArray(e))throw new Error("path must be a string or array. Found "+typeof e);for(var n=0,r=e.length;null!=t&&n<r;)t=t[e[n++]];return n&&n==r?t:void 0}}},n={aeq:r,lt:s,gt:o};function r(t,e){var i,n,r,s;if(t===e)return!0;if(!t||!e||!0===t||!0===e||t!=t||e!=e){switch(t){case void 0:case null:r=1;break;case!1:r=3;break;case!0:r=4;break;case"":r=5;break;default:r=t==t?9:0}switch(e){case void 0:case null:s=1;break;case!1:s=3;break;case!0:s=4;break;case"":s=5;break;default:s=e==e?9:0}if(9!==r||9!==s)return r===s}return i=Number(t),n=Number(e),i==i||n==n?i===n:(i=t.toString())==(n=e.toString())}function s(t,e,i){var n,r,s,o;if(!t||!e||!0===t||!0===e||t!=t||e!=e){switch(t){case void 0:case null:s=1;break;case!1:s=3;break;case!0:s=4;break;case"":s=5;break;default:s=t==t?9:0}switch(e){case void 0:case null:o=1;break;case!1:o=3;break;case!0:o=4;break;case"":o=5;break;default:o=e==e?9:0}if(9!==s||9!==o)return s===o?i:s<o}return n=Number(t),r=Number(e),n==n&&r==r?n<r||!(n>r)&&i:n==n&&r!=r||(r!=r||n==n)&&(t<e||!(t>e)&&(t==e?i:(n=t.toString())<(r=e.toString())||n==r&&i))}function o(t,e,i){var n,r,s,o;if(!t||!e||!0===t||!0===e||t!=t||e!=e){switch(t){case void 0:case null:s=1;break;case!1:s=3;break;case!0:s=4;break;case"":s=5;break;default:s=t==t?9:0}switch(e){case void 0:case null:o=1;break;case!1:o=3;break;case!0:o=4;break;case"":o=5;break;default:o=e==e?9:0}if(9!==s||9!==o)return s===o?i:s>o}return n=Number(t),r=Number(e),n==n&&r==r?n>r||!(n<r)&&i:(n!=n||r==r)&&(r==r&&n!=n||t>e||!(t<e)&&(t==e?i:(n=t.toString())>(r=e.toString())||n==r&&i))}function a(t,e,i){return n.aeq(t,e)?0:n.lt(t,e,!1)?i?1:-1:n.gt(t,e,!1)?i?-1:1:0}function l(t,e,i,n,r){var s,o=r||0,a=e[o],u=!1;if("object"==typeof t&&a in t&&(s=t[a]),o+1>=e.length)u=i(s,n);else if(Array.isArray(s))for(var c=0,h=s.length;c<h&&!0!==(u=l(s[c],e,i,n,o+1));c+=1);else u=l(s,e,i,n,o+1);return u}function u(e){return"string"==typeof e||Array.isArray(e)?function(t){return-1!==e.indexOf(t)}:"object"==typeof e&&null!==e?function(i){return t.call(e,i)}:null}function c(e,i){for(var n in i)if(t.call(i,n))return h[n](e,i[n]);return!1}var h={$eq:function(t,e){return t===e},$aeq:function(t,e){return t==e},$ne:function(t,e){return e!=e?t==t:t!==e},$dteq:function(t,e){return n.aeq(t,e)},$gt:function(t,e){return n.gt(t,e,!1)},$gte:function(t,e){return n.gt(t,e,!0)},$lt:function(t,e){return n.lt(t,e,!1)},$lte:function(t,e){return n.lt(t,e,!0)},$jgt:function(t,e){return t>e},$jgte:function(t,e){return t>=e},$jlt:function(t,e){return t<e},$jlte:function(t,e){return t<=e},$between:function(t,e){return null!=t&&n.gt(t,e[0],!0)&&n.lt(t,e[1],!0)},$jbetween:function(t,e){return null!=t&&t>=e[0]&&t<=e[1]},$in:function(t,e){return-1!==e.indexOf(t)},$nin:function(t,e){return-1===e.indexOf(t)},$keyin:function(t,e){return t in e},$nkeyin:function(t,e){return!(t in e)},$definedin:function(t,e){return void 0!==e[t]},$undefinedin:function(t,e){return void 0===e[t]},$regex:function(t,e){return e.test(t)},$containsString:function(t,e){return"string"==typeof t&&-1!==t.indexOf(e)},$containsNone:function(t,e){return!h.$containsAny(t,e)},$containsAny:function(t,e){var i=u(t);return null!==i&&(Array.isArray(e)?e.some(i):i(e))},$contains:function(t,e){var i=u(t);return null!==i&&(Array.isArray(e)?e.every(i):i(e))},$elemMatch:function(t,e){return!!Array.isArray(t)&&t.some((function(t){return Object.keys(e).every((function(i){var n=e[i];return"object"==typeof n&&n||(n={$eq:n}),-1!==i.indexOf(".")?l(t,i.split("."),c,e[i]):c(t[i],n)}))}))},$type:function(t,e){var i=typeof t;return"object"===i&&(Array.isArray(t)?i="array":t instanceof Date&&(i="date")),"object"!=typeof e?i===e:c(i,e)},$finite:function(t,e){return e===isFinite(t)},$size:function(t,e){return!!Array.isArray(t)&&("object"!=typeof e?t.length===e:c(t.length,e))},$len:function(t,e){return"string"==typeof t&&("object"!=typeof e?t.length===e:c(t.length,e))},$where:function(t,e){return!0===e(t)},$not:function(t,e){return!c(t,e)},$and:function(t,e){for(var i=0,n=e.length;i<n;i+=1)if(!c(t,e[i]))return!1;return!0},$or:function(t,e){for(var i=0,n=e.length;i<n;i+=1)if(c(t,e[i]))return!0;return!1},$exists:function(t,e){return e?void 0!==t:void 0===t}},d={$eq:h.$eq,$aeq:!0,$dteq:!0,$gt:!0,$gte:!0,$lt:!0,$lte:!0,$in:!0,$between:!0};function p(t,e){if(null==t)return null;var i;switch(e||"parse-stringify"){case"parse-stringify":i=JSON.parse(JSON.stringify(t));break;case"jquery-extend-deep":i=jQuery.extend(!0,{},t);break;case"shallow":i=Object.create(t.constructor.prototype),Object.keys(t).map((function(e){i[e]=t[e]}));break;case"shallow-assign":i=Object.create(t.constructor.prototype),Object.assign(i,t);break;case"shallow-recurse-objects":i=p(t,"shallow"),Object.keys(t).forEach((function(e){"object"==typeof t[e]&&"Object"===t[e].constructor.name?i[e]=p(t[e],"shallow-recurse-objects"):Array.isArray(t[e])&&(i[e]=function(t,e){for(var i=[],n=0,r=t.length;n<r;n++)i[n]=p(t[n],"shallow-recurse-objects");return i}(t[e]))}))}return i}function f(){try{return window&&void 0!==window.localStorage&&null!==window.localStorage}catch(t){return!1}}function y(){}function v(t,e){this.filename=t||"loki.db",this.collections=[],this.databaseVersion=1.5,this.engineVersion=1.5,this.autosave=!1,this.autosaveInterval=5e3,this.autosaveHandle=null,this.throttledSaves=!0,this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,this.throttledSavePending=!1,this.throttledCallbacks=[],this.verbose=!(!e||!e.hasOwnProperty("verbose"))&&e.verbose,this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]},this.ENV=e&&e.hasOwnProperty("env")?e.env:"undefined"!=typeof global&&(global.android||global.NSObject)?"NATIVESCRIPT":"undefined"==typeof window?"NODEJS":"undefined"!=typeof global&&global.window&&"undefined"!=typeof process?"NODEJS":"undefined"!=typeof document?-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")?"CORDOVA":"BROWSER":"CORDOVA","undefined"===this.ENV&&(this.ENV="NODEJS"),this.configureOptions(e,!0),this.on("init",this.clearChanges)}function g(t){this.hashStore={},this.options=t||{},this.options.hasOwnProperty("asyncResponses")||(this.options.asyncResponses=!1),this.options.hasOwnProperty("asyncTimeout")||(this.options.asyncTimeout=50)}function b(t,e){if(this.mode="reference",this.adapter=null,this.options=e||{},this.dbref=null,this.dbname="",this.pageIterator={},!t)throw new Error("LokiPartitioningAdapter requires a (non-reference mode) adapter on construction");if("reference"===t.mode)throw new Error("LokiPartitioningAdapter cannot be instantiated with a reference mode adapter");this.adapter=t,this.options.hasOwnProperty("paging")||(this.options.paging=!1),this.options.hasOwnProperty("pageSize")||(this.options.pageSize=26214400),this.options.hasOwnProperty("delimiter")||(this.options.delimiter="$<\n")}function m(){try{this.fs=i(4)}catch(t){this.fs=null}}function w(){}function I(t,e){return e=e||{},this.collection=t,this.filteredrows=[],this.filterInitialized=!1,this}function O(t,e,i){this.collection=t,this.name=e,this.rebuildPending=!1,this.options=i||{},this.options.hasOwnProperty("persistent")||(this.options.persistent=!1),this.options.hasOwnProperty("sortPriority")||(this.options.sortPriority="passive"),this.options.hasOwnProperty("minRebuildInterval")||(this.options.minRebuildInterval=1),this.resultset=new I(t),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.sortFunction=null,this.sortCriteria=null,this.sortCriteriaSimple=null,this.sortDirty=!1,this.events={rebuild:[]}}function x(e,i){this.name=e,this.data=[],this.idIndex=[],this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[],this.transforms={},this.objType=e,this.dirty=!0,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null;var n=this;(i=i||{}).hasOwnProperty("unique")&&(Array.isArray(i.unique)||(i.unique=[i.unique]),i.unique.forEach((function(t){n.uniqueNames.push(t),n.constraints.unique[t]=new q(t)}))),i.hasOwnProperty("exact")&&i.exact.forEach((function(t){n.constraints.exact[t]=new E(t)})),this.adaptiveBinaryIndices=!i.hasOwnProperty("adaptiveBinaryIndices")||i.adaptiveBinaryIndices,this.transactional=!!i.hasOwnProperty("transactional")&&i.transactional,this.cloneObjects=!!i.hasOwnProperty("clone")&&i.clone,this.cloneMethod=i.hasOwnProperty("cloneMethod")?i.cloneMethod:"parse-stringify",this.asyncListeners=!!i.hasOwnProperty("asyncListeners")&&i.asyncListeners,this.disableMeta=!!i.hasOwnProperty("disableMeta")&&i.disableMeta,this.disableChangesApi=!i.hasOwnProperty("disableChangesApi")||i.disableChangesApi,this.disableDeltaChangesApi=!i.hasOwnProperty("disableDeltaChangesApi")||i.disableDeltaChangesApi,this.disableChangesApi&&(this.disableDeltaChangesApi=!0),this.autoupdate=!!i.hasOwnProperty("autoupdate")&&i.autoupdate,this.serializableIndices=!i.hasOwnProperty("serializableIndices")||i.serializableIndices,this.ttl={age:null,ttlInterval:null,daemon:null},this.setTTL(i.ttl||-1,i.ttlInterval),this.maxId=0,this.DynamicViews=[],this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],delete:[],warning:[]},this.changes=[],this.dirtyIds=[],this.ensureId();var r=[];if(i&&i.indices)if("[object Array]"===Object.prototype.toString.call(i.indices))r=i.indices;else{if("string"!=typeof i.indices)throw new TypeError("Indices needs to be a string or an array of strings");r=[i.indices]}for(var s=0;s<r.length;s++)this.ensureIndex(r[s]);function o(t,e){var i=null!==e&&"object"==typeof e?Object.keys(e):null;if(i&&i.length&&["string","boolean","number"].indexOf(typeof e)<0){for(var r={},s=0;s<i.length;s++){var a=i[s];if(e.hasOwnProperty(a))if(!t.hasOwnProperty(a)||n.uniqueNames.indexOf(a)>=0||"$loki"==a||"meta"==a)r[a]=e[a];else{var l=o(t[a],e[a]);void 0!==l&&l!={}&&(r[a]=l)}}return 0===Object.keys(r).length?void 0:r}return t===e?void 0:e}function a(){n.changes=[]}this.observerCallback=function(e){var i="function"==typeof Set?new Set:[];i.add||(i.add=function(t){return-1===this.indexOf(t)&&this.push(t),this}),e.forEach((function(t){i.add(t.object)})),i.forEach((function(e){if(!t.call(e,"$loki"))return n.removeAutoUpdateObserver(e);try{n.update(e)}catch(i){}}))},this.getChangeDelta=function(t,e){return e?o(e,t):JSON.parse(JSON.stringify(t))},this.getObjectDelta=o,this.getChanges=function(){return n.changes},this.flushChanges=a,this.setChangesApi=function(t){n.disableChangesApi=!t,t||(n.disableDeltaChangesApi=!1)},this.on("delete",(function(t){n.disableChangesApi||n.createChange(n.name,"R",t)})),this.on("warning",(function(t){n.lokiConsoleWrapper.warn(t)})),a()}function k(t){return-1!==t.indexOf(".")}function A(t){return parseFloat(t,10)}function D(t,e){return t+e}function C(t,e){return t-e}function S(t){return t.reduce(D,0)/t.length}function P(t,e,i){if(!1===i)return t[e];for(var n=e.split("."),r=t;n.length>0;)r=r[n.shift()];return r}function N(t,e,i){for(var n,r,s=0,o=t.length;s<o;){if(0===(n=i.apply(null,[e,t[r=s+o>>1]])))return{found:!0,index:r};n<0?o=r:s=r+1}return{found:!1,index:o}}function j(t){return function(e,i){return N(e,i,t)}}function $(){}function q(t){this.field=t,this.keyMap={},this.lokiMap={}}function E(t){this.index={},this.field=t}return y.prototype.events={},y.prototype.asyncListeners=!1,y.prototype.on=function(t,e){var i,n=this;return Array.isArray(t)?(t.forEach((function(t){n.on(t,e)})),e):((i=this.events[t])||(i=this.events[t]=[]),i.push(e),e)},y.prototype.emit=function(t){var e=this,i=Array.prototype.slice.call(arguments,1);if(!t||!this.events[t])throw new Error("No event "+t+" defined");this.events[t].forEach((function(t){e.asyncListeners?setTimeout((function(){t.apply(e,i)}),1):t.apply(e,i)}))},y.prototype.addListener=y.prototype.on,y.prototype.removeListener=function(t,e){var i=this;if(Array.isArray(t))t.forEach((function(t){i.removeListener(t,e)}));else if(this.events[t]){var n=this.events[t];n.splice(n.indexOf(e),1)}},(v.prototype=new y).constructor=v,v.prototype.getIndexedAdapter=function(){return i("pnzC")},v.prototype.configureOptions=function(t,e){var i={fs:m,localStorage:w,memory:g};if(this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,void 0!==t){if(this.options=t,this.options.hasOwnProperty("persistenceMethod")&&"function"==typeof i[t.persistenceMethod]&&(this.persistenceMethod=t.persistenceMethod,this.persistenceAdapter=new i[t.persistenceMethod]),this.options.hasOwnProperty("adapter")&&(this.persistenceMethod="adapter",this.persistenceAdapter=t.adapter,this.options.adapter=null,this.isIncremental="incremental"===this.persistenceAdapter.mode),t.autoload&&e){var n=this;setTimeout((function(){n.loadDatabase(t,t.autoloadCallback)}),1)}this.options.hasOwnProperty("autosaveInterval")&&(this.autosaveDisable(),this.autosaveInterval=parseInt(this.options.autosaveInterval,10)),this.options.hasOwnProperty("autosave")&&this.options.autosave&&(this.autosaveDisable(),this.autosave=!0,this.options.hasOwnProperty("autosaveCallback")?this.autosaveEnable(t,t.autosaveCallback):this.autosaveEnable()),this.options.hasOwnProperty("throttledSaves")&&(this.throttledSaves=this.options.throttledSaves)}this.options.hasOwnProperty("serializationMethod")||(this.options.serializationMethod="normal"),this.options.hasOwnProperty("destructureDelimiter")||(this.options.destructureDelimiter="$<\n"),null===this.persistenceAdapter&&(this.persistenceMethod={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage",MEMORY:"memory"}[this.ENV],this.persistenceMethod&&(this.persistenceAdapter=new i[this.persistenceMethod]))},v.prototype.copy=function(t){var e,i,n=new v(this.filename,{env:"NA"});if(t=t||{},n.loadJSONObject(this,{retainDirtyFlags:!0}),t.hasOwnProperty("removeNonSerializable")&&!0===t.removeNonSerializable)for(n.autosaveHandle=null,n.persistenceAdapter=null,e=n.collections.length,i=0;i<e;i++)n.collections[i].constraints=null,n.collections[i].ttl=null;return n},v.prototype.addCollection=function(t,e){var i,n=this.collections.length;if(e&&!0===e.disableMeta){if(!1===e.disableChangesApi)throw new Error("disableMeta option cannot be passed as true when disableChangesApi is passed as false");if(!1===e.disableDeltaChangesApi)throw new Error("disableMeta option cannot be passed as true when disableDeltaChangesApi is passed as false");if("number"==typeof e.ttl&&e.ttl>0)throw new Error("disableMeta option cannot be passed as true when ttl is enabled")}for(i=0;i<n;i+=1)if(this.collections[i].name===t)return this.collections[i];var r=new x(t,e);return r.isIncremental=this.isIncremental,this.collections.push(r),this.verbose&&(r.lokiConsoleWrapper=console),r},v.prototype.loadCollection=function(t){if(!t.name)throw new Error("Collection must have a name property to be loaded");this.collections.push(t)},v.prototype.getCollection=function(t){var e,i=this.collections.length;for(e=0;e<i;e+=1)if(this.collections[e].name===t)return this.collections[e];return this.emit("warning","collection "+t+" not found"),null},v.prototype.renameCollection=function(t,e){var i=this.getCollection(t);return i&&(i.name=e),i},v.prototype.listCollections=function(){for(var t=this.collections.length,e=[];t--;)e.push({name:this.collections[t].name,type:this.collections[t].objType,count:this.collections[t].data.length});return e},v.prototype.removeCollection=function(t){var e,i=this.collections.length;for(e=0;e<i;e+=1)if(this.collections[e].name===t){var n=new x(t,{}),r=this.collections[e];for(var s in r)r.hasOwnProperty(s)&&n.hasOwnProperty(s)&&(r[s]=n[s]);return void this.collections.splice(e,1)}},v.prototype.getName=function(){return this.name},v.prototype.serializeReplacer=function(t,e){switch(t){case"autosaveHandle":case"persistenceAdapter":case"constraints":case"ttl":return null;case"throttledSavePending":case"throttledCallbacks":return;case"lokiConsoleWrapper":return null;default:return e}},v.prototype.toJson=v.prototype.serialize=function(t){switch((t=t||{}).hasOwnProperty("serializationMethod")||(t.serializationMethod=this.options.serializationMethod),t.serializationMethod){case"normal":return JSON.stringify(this,this.serializeReplacer);case"pretty":return JSON.stringify(this,this.serializeReplacer,2);case"destructured":return this.serializeDestructured();default:return JSON.stringify(this,this.serializeReplacer)}},v.prototype.serializeDestructured=function(t){var e,i,n,r,s,o=[];if((t=t||{}).hasOwnProperty("partitioned")||(t.partitioned=!1),t.hasOwnProperty("delimited")||(t.delimited=!0),t.hasOwnProperty("delimiter")||(t.delimiter=this.options.destructureDelimiter),!0===t.partitioned&&t.hasOwnProperty("partition")&&t.partition>=0)return this.serializeCollection({delimited:t.delimited,delimiter:t.delimiter,collectionIndex:t.partition});for((s=new v(this.filename)).loadJSONObject(this),e=0;e<s.collections.length;e++)s.collections[e].data=[];if(!0===t.partitioned&&-1===t.partition)return s.serialize({serializationMethod:"normal"});for(o.push(s.serialize({serializationMethod:"normal"})),s=null,e=0;e<this.collections.length;e++)if(n=this.serializeCollection({delimited:t.delimited,delimiter:t.delimiter,collectionIndex:e}),!1===t.partitioned&&!1===t.delimited){if(!Array.isArray(n))throw new Error("a nondelimited, non partitioned collection serialization did not return an expected array");for(r=n.length,i=0;i<r;i++)o.push(n[i]),n[i]=null;o.push("")}else o.push(n);return t.partitioned?o:t.delimited?(o.push(""),o.join(t.delimiter)):(o.push(""),o)},v.prototype.serializeCollection=function(t){var e,i,n=[];if((t=t||{}).hasOwnProperty("delimited")||(t.delimited=!0),!t.hasOwnProperty("collectionIndex"))throw new Error("serializeCollection called without 'collectionIndex' option");for(e=this.collections[t.collectionIndex].data.length,n=[],i=0;i<e;i++)n.push(JSON.stringify(this.collections[t.collectionIndex].data[i]));return t.delimited?(n.push(""),n.join(t.delimiter)):n},v.prototype.deserializeDestructured=function(t,e){var i,n,r,s=[],o=0,a=1,l=!1;if((e=e||{}).hasOwnProperty("partitioned")||(e.partitioned=!1),e.hasOwnProperty("delimited")||(e.delimited=!0),e.hasOwnProperty("delimiter")||(e.delimiter=this.options.destructureDelimiter),e.partitioned){if(e.hasOwnProperty("partition"))return-1===e.partition?i=JSON.parse(t[0]):this.deserializeCollection(t[e.partition+1],e);for(n=(i=JSON.parse(t[0])).collections.length,o=0;o<n;o++)i.collections[o].data=this.deserializeCollection(t[o+1],e);return i}if(e.delimited){if(s=t.split(e.delimiter),t=null,0===s.length)return null}else s=t;for(n=(i=JSON.parse(s[0])).collections.length,s[0]=null;!l;)""===s[a]?++o>n&&(l=!0):(r=JSON.parse(s[a]),i.collections[o].data.push(r)),s[a++]=null;return i},v.prototype.deserializeCollection=function(t,e){var i,n,r=[];for((e=e||{}).hasOwnProperty("partitioned")||(e.partitioned=!1),e.hasOwnProperty("delimited")||(e.delimited=!0),e.hasOwnProperty("delimiter")||(e.delimiter=this.options.destructureDelimiter),e.delimited?(r=t.split(e.delimiter)).pop():r=t,n=r.length,i=0;i<n;i++)r[i]=JSON.parse(r[i]);return r},v.prototype.loadJSON=function(t,e){var i;if(0===t.length)i={};else switch(this.options.serializationMethod){case"normal":case"pretty":i=JSON.parse(t);break;case"destructured":i=this.deserializeDestructured(t);break;default:i=JSON.parse(t)}this.loadJSONObject(i,e)},v.prototype.loadJSONObject=function(t,i){var n,r,s,o,a,l,u=0,c=t.collections?t.collections.length:0;function h(t){var n,r=i[t.name];return r.proto?(n=r.inflate||e.copyProperties,function(t){var e=new r.proto;return n(t,e),e}):r.inflate}for(this.name=t.name,t.hasOwnProperty("throttledSaves")&&i&&!i.hasOwnProperty("throttledSaves")&&(this.throttledSaves=t.throttledSaves),this.collections=[];u<c;u+=1){if((r=this.addCollection((n=t.collections[u]).name,{disableChangesApi:n.disableChangesApi,disableDeltaChangesApi:n.disableDeltaChangesApi,disableMeta:n.disableMeta})).adaptiveBinaryIndices=!!n.hasOwnProperty("adaptiveBinaryIndices")&&!0===n.adaptiveBinaryIndices,r.transactional=n.transactional,r.asyncListeners=n.asyncListeners,r.cloneObjects=n.cloneObjects,r.cloneMethod=n.cloneMethod||"parse-stringify",r.autoupdate=n.autoupdate,r.changes=n.changes,r.dirtyIds=n.dirtyIds||[],r.dirty=!(!i||!0!==i.retainDirtyFlags)&&n.dirty,s=n.data.length,o=0,i&&i.hasOwnProperty(n.name))for(a=h(n);o<s;o++)l=a(n.data[o]),r.data[o]=l,r.addAutoUpdateObserver(l);else for(;o<s;o++)r.data[o]=n.data[o],r.addAutoUpdateObserver(r.data[o]);if(r.maxId=void 0===n.maxId?0:n.maxId,r.idIndex=n.idIndex,void 0!==n.binaryIndices&&(r.binaryIndices=n.binaryIndices),void 0!==n.transforms&&(r.transforms=n.transforms),r.ensureId(),r.uniqueNames=[],n.hasOwnProperty("uniqueNames"))for(r.uniqueNames=n.uniqueNames,o=0;o<r.uniqueNames.length;o++)r.ensureUniqueIndex(r.uniqueNames[o]);if(void 0!==n.DynamicViews){for(var d=0;d<n.DynamicViews.length;d++){var p=n.DynamicViews[d],f=r.addDynamicView(p.name,p.options);f.resultdata=p.resultdata,f.resultsdirty=p.resultsdirty,f.filterPipeline=p.filterPipeline,f.sortCriteria=p.sortCriteria,f.sortFunction=null,f.sortDirty=p.sortDirty,f.resultset.filteredrows=p.resultset.filteredrows,f.resultset.filterInitialized=p.resultset.filterInitialized,f.rematerialize({removeWhereFilters:!0})}t.databaseVersion<1.5&&(r.ensureAllIndexes(!0),r.dirty=!0)}}},v.prototype.close=function(t){this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&(this.saveDatabase(t),t=void 0)),t&&this.on("close",t),this.emit("close")},v.prototype.generateChangesNotification=function(t){function e(t){return t.name}var i=[],n=t||this.collections.map(e);return this.collections.forEach((function(t){-1!==n.indexOf(e(t))&&(i=i.concat(t.getChanges()))})),i},v.prototype.serializeChanges=function(t){return JSON.stringify(this.generateChangesNotification(t))},v.prototype.clearChanges=function(){this.collections.forEach((function(t){t.flushChanges&&t.flushChanges()}))},g.prototype.loadDatabase=function(t,e){var i=this;this.options.asyncResponses?setTimeout((function(){i.hashStore.hasOwnProperty(t)?e(i.hashStore[t].value):e(null)}),this.options.asyncTimeout):this.hashStore.hasOwnProperty(t)?e(this.hashStore[t].value):e(null)},g.prototype.saveDatabase=function(t,e,i){var n,r=this;this.options.asyncResponses?setTimeout((function(){n=r.hashStore.hasOwnProperty(t)?r.hashStore[t].savecount:0,r.hashStore[t]={savecount:n+1,lastsave:new Date,value:e},i()}),this.options.asyncTimeout):(n=this.hashStore.hasOwnProperty(t)?this.hashStore[t].savecount:0,this.hashStore[t]={savecount:n+1,lastsave:new Date,value:e},i())},g.prototype.deleteDatabase=function(t,e){this.hashStore.hasOwnProperty(t)&&delete this.hashStore[t],"function"==typeof e&&e()},b.prototype.loadDatabase=function(t,e){var i=this;this.dbname=t,this.dbref=new v(t),this.adapter.loadDatabase(t,(function(t){if(t){"string"!=typeof t&&e(new Error("LokiPartitioningAdapter received an unexpected response from inner adapter loadDatabase()"));var n=JSON.parse(t);i.dbref.loadJSONObject(n),n=null,0!==i.dbref.collections.length?(i.pageIterator={collection:0,pageIndex:0},i.loadNextPartition(0,(function(){e(i.dbref)}))):e(i.dbref)}else e(t)}))},b.prototype.loadNextPartition=function(t,e){var i=this.dbname+"."+t,n=this;if(!0===this.options.paging)return this.pageIterator.pageIndex=0,void this.loadNextPage(e);this.adapter.loadDatabase(i,(function(i){var r=n.dbref.deserializeCollection(i,{delimited:!0,collectionIndex:t});n.dbref.collections[t].data=r,++t<n.dbref.collections.length?n.loadNextPartition(t,e):e()}))},b.prototype.loadNextPage=function(t){var e=this;this.adapter.loadDatabase(this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,(function(i){var n=i.split(e.options.delimiter);i="";var r,s=n.length,o=""===n[s-1];for(o&&(n.pop(),""===n[(s=n.length)-1]&&1===s&&(n.pop(),s=n.length)),r=0;r<s;r++)e.dbref.collections[e.pageIterator.collection].data.push(JSON.parse(n[r])),n[r]=null;n=[],o?++e.pageIterator.collection<e.dbref.collections.length?e.loadNextPartition(e.pageIterator.collection,t):t():(e.pageIterator.pageIndex++,e.loadNextPage(t))}))},b.prototype.exportDatabase=function(t,e,i){var n,r=e.collections.length;for(this.dbref=e,this.dbname=t,this.dirtyPartitions=[-1],n=0;n<r;n++)e.collections[n].dirty&&this.dirtyPartitions.push(n);this.saveNextPartition((function(t){i(t)}))},b.prototype.saveNextPartition=function(t){var e=this,i=this.dirtyPartitions.shift(),n=this.dbname+(-1===i?"":"."+i);if(this.options.paging&&-1!==i)return this.pageIterator={collection:i,docIndex:0,pageIndex:0},void this.saveNextPage((function(i){0===e.dirtyPartitions.length?t(i):e.saveNextPartition(t)}));var r=this.dbref.serializeDestructured({partitioned:!0,delimited:!0,partition:i});this.adapter.saveDatabase(n,r,(function(i){i?t(i):0===e.dirtyPartitions.length?t(null):e.saveNextPartition(t)}))},b.prototype.saveNextPage=function(t){var e=this,i=this.dbref.collections[this.pageIterator.collection],n=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,r=0,s=i.data.length,o=this.options.delimiter.length,a="",l="",u=!1,c=!1,h=function(i){l="",i&&t(i),u?t(null):(e.pageIterator.pageIndex++,e.saveNextPage(t))};for(0===i.data.length&&(u=!0);;)if(u||(a=JSON.stringify(i.data[this.pageIterator.docIndex]),l+=a,r+=a.length,++this.pageIterator.docIndex>=s&&(u=!0)),r>=this.options.pageSize&&(c=!0),c&&!u||(l+=this.options.delimiter,r+=o),u||c)return void this.adapter.saveDatabase(n,l,h)},m.prototype.loadDatabase=function(t,e){var i=this;this.fs.stat(t,(function(n,r){!n&&r.isFile()?i.fs.readFile(t,{encoding:"utf8"},(function(t,i){e(t?new Error(t):i)})):e(null)}))},m.prototype.saveDatabase=function(t,e,i){var n=this,r=t+"~";this.fs.writeFile(r,e,(function(e){e?i(new Error(e)):n.fs.rename(r,t,i)}))},m.prototype.deleteDatabase=function(t,e){this.fs.unlink(t,(function(t){t?e(new Error(t)):e()}))},w.prototype.loadDatabase=function(t,e){f()?e(localStorage.getItem(t)):e(new Error("localStorage is not available"))},w.prototype.saveDatabase=function(t,e,i){f()?(localStorage.setItem(t,e),i(null)):i(new Error("localStorage is not available"))},w.prototype.deleteDatabase=function(t,e){f()?(localStorage.removeItem(t),e(null)):e(new Error("localStorage is not available"))},v.prototype.throttledSaveDrain=function(t,e){var i=this,n=(new Date).getTime();if(this.throttledSaves||t(!0),(e=e||{}).hasOwnProperty("recursiveWait")||(e.recursiveWait=!0),e.hasOwnProperty("recursiveWaitLimit")||(e.recursiveWaitLimit=!1),e.hasOwnProperty("recursiveWaitLimitDuration")||(e.recursiveWaitLimitDuration=2e3),e.hasOwnProperty("started")||(e.started=(new Date).getTime()),this.throttledSaves&&this.throttledSavePending){if(!e.recursiveWait)return void this.throttledCallbacks.push(t);this.throttledCallbacks.push((function(){return i.throttledSavePending?e.recursiveWaitLimit&&n-e.started>e.recursiveWaitLimitDuration?void t(!1):void i.throttledSaveDrain(t,e):void t(!0)}))}else t(!0)},v.prototype.loadDatabaseInternal=function(t,e){var i=e||function(t,e){if(t)throw t},n=this;null!==this.persistenceAdapter?this.persistenceAdapter.loadDatabase(this.filename,(function(e){if("string"==typeof e){var r=!1;try{n.loadJSON(e,t||{}),r=!0}catch(s){i(s)}r&&(i(null),n.emit("loaded","database "+n.filename+" loaded"))}else{if(!e)return i(null),void n.emit("loaded","empty database "+n.filename+" loaded");if(e instanceof Error)return void i(e);if("object"==typeof e)return n.loadJSONObject(e,t||{}),i(null),void n.emit("loaded","database "+n.filename+" loaded");i("unexpected adapter response : "+e)}})):i(new Error("persistenceAdapter not configured"))},v.prototype.loadDatabase=function(t,e){var i=this;this.throttledSaves?this.throttledSaveDrain((function(n){if(n)return i.throttledSavePending=!0,void i.loadDatabaseInternal(t,(function(t){0===i.throttledCallbacks.length?i.throttledSavePending=!1:i.saveDatabase(),"function"==typeof e&&e(t)}));"function"==typeof e&&e(new Error("Unable to pause save throttling long enough to read database"))}),t):this.loadDatabaseInternal(t,e)},v.prototype.saveDatabaseInternal=function(t){var e=t||function(t){if(t)throw t},i=this;if(this.persistenceAdapter)if("reference"!==this.persistenceAdapter.mode&&this.autosaveClearFlags(),"incremental"===this.persistenceAdapter.mode){var n=this.copy({removeNonSerializable:!0}),r=this.collections.map((function(t){return t.dirtyIds}));this.collections.forEach((function(t){t.dirtyIds=[]})),this.persistenceAdapter.saveDatabase(this.filename,n,(function(t){t&&i.collections.forEach((function(t,e){t.dirtyIds=t.dirtyIds.concat(r[e])})),e(t)}))}else"reference"===this.persistenceAdapter.mode&&"function"==typeof this.persistenceAdapter.exportDatabase?this.persistenceAdapter.exportDatabase(this.filename,this.copy({removeNonSerializable:!0}),(function(t){i.autosaveClearFlags(),e(t)})):this.persistenceAdapter.saveDatabase(this.filename,this.serialize(),(function(t){e(t)}));else e(new Error("persistenceAdapter not configured"))},v.prototype.save=v.prototype.saveDatabase=function(t){if(this.throttledSaves)if(this.throttledSavePending)this.throttledCallbacks.push(t);else{var e=this.throttledCallbacks;this.throttledCallbacks=[],e.unshift(t),this.throttledSavePending=!0;var i=this;this.saveDatabaseInternal((function(t){i.throttledSavePending=!1,e.forEach((function(e){"function"==typeof e&&setTimeout((function(){e(t)}),1)})),i.throttledCallbacks.length>0&&i.saveDatabase()}))}else this.saveDatabaseInternal(t)},v.prototype.deleteDatabase=function(t,e){var i=e||function(t,e){if(t)throw t};"function"!=typeof t||e||(i=t),null!==this.persistenceAdapter?this.persistenceAdapter.deleteDatabase(this.filename,(function(t){i(t)})):i(new Error("persistenceAdapter not configured"))},v.prototype.autosaveDirty=function(){for(var t=0;t<this.collections.length;t++)if(this.collections[t].dirty)return!0;return!1},v.prototype.autosaveClearFlags=function(){for(var t=0;t<this.collections.length;t++)this.collections[t].dirty=!1},v.prototype.autosaveEnable=function(t,e){this.autosave=!0;var i=5e3,n=this;null!=this.autosaveInterval&&(i=this.autosaveInterval),this.autosaveHandle=setInterval((function(){n.autosaveDirty()&&n.saveDatabase(e)}),i)},v.prototype.autosaveDisable=function(){null!=this.autosaveHandle&&(clearInterval(this.autosaveHandle),this.autosaveHandle=null)},I.prototype.reset=function(){return this.filteredrows.length>0&&(this.filteredrows=[]),this.filterInitialized=!1,this},I.prototype.toJSON=function(){var t=this.copy();return t.collection=null,t},I.prototype.limit=function(t){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var e=new I(this.collection);return e.filteredrows=this.filteredrows.slice(0,t),e.filterInitialized=!0,e},I.prototype.offset=function(t){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var e=new I(this.collection);return e.filteredrows=this.filteredrows.slice(t),e.filterInitialized=!0,e},I.prototype.copy=function(){var t=new I(this.collection);return this.filteredrows.length>0&&(t.filteredrows=this.filteredrows.slice()),t.filterInitialized=this.filterInitialized,t},I.prototype.branch=I.prototype.copy,I.prototype.transform=function(t,i){var n,r,s=this;if("string"==typeof t&&this.collection.transforms.hasOwnProperty(t)&&(t=this.collection.transforms[t]),"object"!=typeof t||!Array.isArray(t))throw new Error("Invalid transform");for(void 0!==i&&(t=e.resolveTransformParams(t,i)),n=0;n<t.length;n++)switch((r=t[n]).type){case"find":s.find(r.value);break;case"where":s.where(r.value);break;case"simplesort":s.simplesort(r.property,r.desc||r.options);break;case"compoundsort":s.compoundsort(r.value);break;case"sort":s.sort(r.value);break;case"limit":s=s.limit(r.value);break;case"offset":s=s.offset(r.value);break;case"map":s=s.map(r.value,r.dataOptions);break;case"eqJoin":s=s.eqJoin(r.joinData,r.leftJoinKey,r.rightJoinKey,r.mapFun,r.dataOptions);break;case"mapReduce":s=s.mapReduce(r.mapFunction,r.reduceFunction);break;case"update":s.update(r.value);break;case"remove":s.remove()}return s},I.prototype.sort=function(t){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var e,i,n=(e=t,i=this.collection.data,function(t,n){return e(i[t],i[n])});return this.filteredrows.sort(n),this},I.prototype.simplesort=function(t,i){var n=10,r=this.collection.data.length,s=this.filteredrows.length,o=this.collection.binaryIndices.hasOwnProperty(t);if(void 0!==i&&!1!==i||(i={desc:!1}),!0===i&&(i={desc:!0}),0===s){if(this.filterInitialized)return this;if(this.collection.binaryIndices.hasOwnProperty(t))return this.collection.ensureIndex(t),this.filteredrows=this.collection.binaryIndices[t].values.slice(0),i.desc&&this.filteredrows.reverse(),this;this.filteredrows=this.collection.prepareFullDocIndex()}else if(!i.disableIndexIntersect&&o&&(i.useJavascriptSorting&&(n=6),r/s<=n||i.forceIndexIntersect)){var l,u=this.filteredrows,c={};for(l=0;l<s;l++)c[u[l]]=!0;return this.filteredrows=this.collection.binaryIndices[t].values.filter((function(t){return c[t]})),i.desc&&this.filteredrows.reverse(),this}if(i.useJavascriptSorting)return this.sort((function(e,i){return e[t]===i[t]?0:e[t]>i[t]?1:e[t]<i[t]?-1:void 0}));var h,d,p,f,y,v,g=(h=t,d=i.desc,p=this.collection.data,function(t,i){return~h.indexOf(".")?(v=h.split("."),f=e.getIn(p[t],v,!0),y=e.getIn(p[i],v,!0)):(f=p[t][h],y=p[i][h]),a(f,y,d)});return this.filteredrows.sort(g),this},I.prototype.compoundsort=function(t){if(0===t.length)throw new Error("Invalid call to compoundsort, need at least one property");var i;if(1===t.length)return i=t[0],Array.isArray(i)?this.simplesort(i[0],i[1]):this.simplesort(i,!1);for(var n=0,r=t.length;n<r;n+=1)i=t[n],Array.isArray(i)||(t[n]=[i,!1]);this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var s,o,l=(s=t,o=this.collection.data,function(t,i){return function(t,i,n){for(var r,s,o,l,u,c=0,h=0,d=t.length;h<d;h++)if(~(s=(r=t[h])[0]).indexOf(".")?(u=s.split("."),o=e.getIn(i,u,!0),l=e.getIn(n,u,!0)):(o=i[s],l=n[s]),0!==(c=a(o,l,r[1])))return c;return 0}(s,o[t],o[i])});return this.filteredrows.sort(l),this},I.prototype.$or=I.prototype.findOr=function(t){for(var e=null,i=0,n=0,r=[],s=[],o=0,a=(this.count(),0),l=t.length;a<l;a++)for(n=(e=this.branch().find(t[a]).filteredrows).length,i=0;i<n;i++)void 0===s[o=e[i]]&&(s[o]=!0,r.push(o));return this.filteredrows=r,this.filterInitialized=!0,this},I.prototype.$and=I.prototype.findAnd=function(t){for(var e=0,i=t.length;e<i;e++){if(0===this.count())return this;this.find(t[e])}return this},I.prototype.find=function(i,n){if(0===this.collection.data.length)return this.filteredrows=[],this.filterInitialized=!0,this;var r,s,o,a,u,c,p,f=i||"getAll",y=!1,v=[],g=[],b=null;if(n=n||!1,"object"==typeof f){for(r in f)(a={})[r]=f[r],g.push(a),t.call(f,r)&&(s=r,o=f[r]);if(g.length>1)return this.find({$and:g},n)}if(!s||"getAll"===f)return n&&(this.filterInitialized?this.filteredrows=this.filteredrows.slice(0,1):(this.filteredrows=this.collection.data.length>0?[0]:[],this.filterInitialized=!0)),this;if("$and"===s||"$or"===s)return this[s](o),n&&this.filteredrows.length>1&&(this.filteredrows=this.filteredrows.slice(0,1)),this;if(null===o||"object"!=typeof o||o instanceof Date)u="$eq",c=o;else{if("object"!=typeof o)throw new Error("Do not know what you want to do.");for(p in o)if(t.call(o,p)){u=p,c=o[p];break}}"$regex"!==u&&"object"!=typeof c||(c=function t(e,i){if("$regex"===e)Array.isArray(i)?i=new RegExp(i[0],i[1]):i instanceof RegExp||(i=new RegExp(i));else if("object"==typeof i)for(var n in i)"$regex"!==n&&"object"!=typeof i[n]||(i[n]=t(n,i[n]));return i}(u,c));var m=-1!==s.indexOf(".");!this.filterInitialized&&this.collection.binaryIndices[s]&&d[u]&&(!0!==this.collection.adaptiveBinaryIndices&&this.collection.ensureIndex(s),y=!0,b=this.collection.binaryIndices[s]);var w,I=h[u],O=this.collection.data,x=0,k=0,A=0;if(this.filterInitialized){if(k=(w=this.filteredrows).length,m){for(s=s.split("."),x=0;x<k;x++)if(l(O[A=w[x]],s,I,c)&&(v.push(A),n))return this.filteredrows=v,this}else for(x=0;x<k;x++)if(I(O[A=w[x]][s],c)&&(v.push(A),n))return this.filteredrows=v,this}else if(y){var D=this.collection.calculateRange(u,s,c);if("$in"!==u){for(x=D[0];x<=D[1];x++)if(!0!==d[u]){if(d[u](e.getIn(O[b.values[x]],s,m),c)&&(v.push(b.values[x]),n))return this.filteredrows=v,this.filterInitialized=!0,this}else if(v.push(b.values[x]),n)return this.filteredrows=v,this.filterInitialized=!0,this}else for(x=0,k=D.length;x<k;x++)if(v.push(b.values[D[x]]),n)return this.filteredrows=v,this.filterInitialized=!0,this}else if(k=O.length,m){for(s=s.split("."),x=0;x<k;x++)if(l(O[x],s,I,c)&&(v.push(x),n))return this.filteredrows=v,this.filterInitialized=!0,this}else for(x=0;x<k;x++)if(I(O[x][s],c)&&(v.push(x),n))return this.filteredrows=v,this.filterInitialized=!0,this;return this.filteredrows=v,this.filterInitialized=!0,this},I.prototype.where=function(t){var e,i=[];if("function"!=typeof t)throw new TypeError("Argument is not a stored view or a function");e=t;try{if(this.filterInitialized){for(var n=this.filteredrows.length;n--;)!0===e(this.collection.data[this.filteredrows[n]])&&i.push(this.filteredrows[n]);return this.filteredrows=i,this}for(var r=this.collection.data.length;r--;)!0===e(this.collection.data[r])&&i.push(r);return this.filteredrows=i,this.filterInitialized=!0,this}catch(s){throw s}},I.prototype.count=function(){return this.filterInitialized?this.filteredrows.length:this.collection.count()},I.prototype.data=function(t){var e,i,n,r,s=[],o=this.collection.data;if((t=t||{}).removeMeta&&!t.forceClones&&(t.forceClones=!0,t.forceCloneMethod=t.forceCloneMethod||"shallow"),this.collection.disableDeltaChangesApi||(t.forceClones=!0,t.forceCloneMethod="parse-stringify"),!this.filterInitialized){if(0===this.filteredrows.length){if(this.collection.cloneObjects||t.forceClones){for(i=o.length,r=t.forceCloneMethod||this.collection.cloneMethod,n=0;n<i;n++)e=p(o[n],r),t.removeMeta&&(delete e.$loki,delete e.meta),s.push(e);return s}return o.slice()}this.filterInitialized=!0}var a=this.filteredrows;if(i=a.length,this.collection.cloneObjects||t.forceClones)for(r=t.forceCloneMethod||this.collection.cloneMethod,n=0;n<i;n++)e=p(o[a[n]],r),t.removeMeta&&(delete e.$loki,delete e.meta),s.push(e);else for(n=0;n<i;n++)s.push(o[a[n]]);return s},I.prototype.update=function(t){if("function"!=typeof t)throw new TypeError("Argument is not a function");this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());for(var e,i=this.filteredrows.length,n=this.collection.data,r=0;r<i;r++)this.collection.cloneObjects||!this.collection.disableDeltaChangesApi?(t(e=p(n[this.filteredrows[r]],this.collection.cloneMethod)),this.collection.update(e)):(t(n[this.filteredrows[r]]),this.collection.update(n[this.filteredrows[r]]));return this},I.prototype.remove=function(){return this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex()),this.collection.removeBatchByPositions(this.filteredrows),this.filteredrows=[],this},I.prototype.mapReduce=function(t,e){try{return e(this.data().map(t))}catch(i){throw i}},I.prototype.eqJoin=function(t,e,i,n,r){var s,o,a,l,u=[],c=[],h="function"==typeof e,d="function"==typeof i,p={};if(o=(s=this.data(r)).length,t instanceof x)u=t.chain().data(r);else if(t instanceof I)u=t.data(r);else{if(!Array.isArray(t))throw new TypeError("joinData needs to be an array or result set");u=t}a=u.length;for(var f=0;f<a;f++)p[l=d?i(u[f]):u[f][i]]=u[f];n||(n=function(t,e){return{left:t,right:e}});for(var y=0;y<o;y++)l=h?e(s[y]):s[y][e],c.push(n(s[y],p[l]||{}));return this.collection=new x("joinData"),this.collection.insert(c),this.filteredrows=[],this.filterInitialized=!1,this},I.prototype.map=function(t,e){var i=this.data(e).map(t);return this.collection=new x("mappedData"),this.collection.insert(i),this.filteredrows=[],this.filterInitialized=!1,this},(O.prototype=new y).rematerialize=function(t){var e,i,n;if(t=t||{},this.resultdata=[],this.resultsdirty=!0,this.resultset=new I(this.collection),(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple)&&(this.sortDirty=!0),t.hasOwnProperty("removeWhereFilters"))for(i=e=this.filterPipeline.length;i--;)"where"===this.filterPipeline[i].type&&(i!==this.filterPipeline.length-1&&(this.filterPipeline[i]=this.filterPipeline[this.filterPipeline.length-1]),this.filterPipeline.length--);var r=this.filterPipeline;for(this.filterPipeline=[],e=r.length,n=0;n<e;n++)this.applyFind(r[n].val);return this.data(),this.emit("rebuild",this),this},O.prototype.branchResultset=function(t,e){var i=this.resultset.branch();return void 0===t?i:i.transform(t,e)},O.prototype.toJSON=function(){var t=new O(this.collection,this.name,this.options);return t.resultset=this.resultset,t.resultdata=[],t.resultsdirty=!0,t.filterPipeline=this.filterPipeline,t.sortFunction=this.sortFunction,t.sortCriteria=this.sortCriteria,t.sortCriteriaSimple=this.sortCriteriaSimple||null,t.sortDirty=this.sortDirty,t.collection=null,t},O.prototype.removeFilters=function(t){t=t||{},this.rebuildPending=!1,this.resultset.reset(),this.resultdata=[],this.resultsdirty=!0,this.cachedresultset=null,this.filterPipeline=[],this.sortFunction=null,this.sortCriteria=null,this.sortCriteriaSimple=null,this.sortDirty=!1,!0===t.queueSortPhase&&this.queueSortPhase()},O.prototype.applySort=function(t){return this.sortFunction=t,this.sortCriteria=null,this.sortCriteriaSimple=null,this.queueSortPhase(),this},O.prototype.applySimpleSort=function(t,e){return this.sortCriteriaSimple={propname:t,options:e||!1},this.sortCriteria=null,this.sortFunction=null,this.queueSortPhase(),this},O.prototype.applySortCriteria=function(t){return this.sortCriteria=t,this.sortCriteriaSimple=null,this.sortFunction=null,this.queueSortPhase(),this},O.prototype.startTransaction=function(){return this.cachedresultset=this.resultset.copy(),this},O.prototype.commit=function(){return this.cachedresultset=null,this},O.prototype.rollback=function(){return this.resultset=this.cachedresultset,this.options.persistent&&(this.resultdata=this.resultset.data(),this.emit("rebuild",this)),this},O.prototype._indexOfFilterWithId=function(t){if("string"==typeof t||"number"==typeof t)for(var e=0,i=this.filterPipeline.length;e<i;e+=1)if(t===this.filterPipeline[e].uid)return e;return-1},O.prototype._addFilter=function(t){this.filterPipeline.push(t),this.resultset[t.type](t.val)},O.prototype.reapplyFilters=function(){this.resultset.reset(),this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0);var t=this.filterPipeline;this.filterPipeline=[];for(var e=0,i=t.length;e<i;e+=1)this._addFilter(t[e]);return this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent(),this},O.prototype.applyFilter=function(t){var e=this._indexOfFilterWithId(t.uid);return e>=0?(this.filterPipeline[e]=t,this.reapplyFilters()):(this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0),this._addFilter(t),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent(),this)},O.prototype.applyFind=function(t,e){return this.applyFilter({type:"find",val:t,uid:e}),this},O.prototype.applyWhere=function(t,e){return this.applyFilter({type:"where",val:t,uid:e}),this},O.prototype.removeFilter=function(t){var e=this._indexOfFilterWithId(t);if(e<0)throw new Error("Dynamic view does not contain a filter with ID: "+t);return this.filterPipeline.splice(e,1),this.reapplyFilters(),this},O.prototype.count=function(){return this.resultsdirty&&(this.resultdata=this.resultset.data()),this.resultset.count()},O.prototype.data=function(t){return(this.sortDirty||this.resultsdirty)&&this.performSortPhase({suppressRebuildEvent:!0}),this.options.persistent?this.resultdata:this.resultset.data(t)},O.prototype.queueRebuildEvent=function(){if(!this.rebuildPending){this.rebuildPending=!0;var t=this;setTimeout((function(){t.rebuildPending&&(t.rebuildPending=!1,t.emit("rebuild",t))}),this.options.minRebuildInterval)}},O.prototype.queueSortPhase=function(){if(!this.sortDirty){this.sortDirty=!0;var t=this;"active"===this.options.sortPriority?setTimeout((function(){t.performSortPhase()}),this.options.minRebuildInterval):this.queueRebuildEvent()}},O.prototype.performSortPhase=function(t){(this.sortDirty||this.resultsdirty)&&(t=t||{},this.sortDirty&&(this.sortFunction?this.resultset.sort(this.sortFunction):this.sortCriteria?this.resultset.compoundsort(this.sortCriteria):this.sortCriteriaSimple&&this.resultset.simplesort(this.sortCriteriaSimple.propname,this.sortCriteriaSimple.options),this.sortDirty=!1),this.options.persistent&&(this.resultdata=this.resultset.data(),this.resultsdirty=!1),t.suppressRebuildEvent||this.emit("rebuild",this))},O.prototype.evaluateDocument=function(t,e){if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());var i,n=this.resultset.filteredrows,r=e?-1:n.indexOf(+t),s=n.length,o=new I(this.collection);o.filteredrows=[t],o.filterInitialized=!0;for(var a=0,l=this.filterPipeline.length;a<l;a++)o[(i=this.filterPipeline[a]).type](i.val);var u=0===o.filteredrows.length?-1:0;return-1!==r||-1!==u?-1===r&&-1!==u?(n.push(t),this.options.persistent&&this.resultdata.push(this.collection.data[t]),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())):-1!==r&&-1===u?(r<s-1?(n.splice(r,1),this.options.persistent&&this.resultdata.splice(r,1)):(n.length=s-1,this.options.persistent&&(this.resultdata.length=s-1)),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())):-1!==r&&-1!==u?(this.options.persistent&&(this.resultdata[r]=this.collection.data[t]),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())):void 0:void 0},O.prototype.removeDocument=function(t){var e,i,n,r={},s={},o=[],a=this.resultset,l=this.resultset.filteredrows,u=l.length;if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());for(Array.isArray(t)||(t=[t]),n=t.length,i=0;i<n;i++)r[t[i]]=!0;for(e=0;e<u;e++)r[l[e]]&&(s[e]=!0);Object.keys(s).length>0&&(this.resultset.filteredrows=this.resultset.filteredrows.filter((function(t,e){return!s[e]})),this.options.persistent&&(this.resultdata=this.resultdata.filter((function(t,e){return!s[e]}))),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());var c=function(t){return function(e){return e<a.filteredrows[t]}};for(u=a.filteredrows.length,e=0;e<u;e++)o=t.filter(c(e)),a.filteredrows[e]-=o.length},O.prototype.mapReduce=function(t,e){try{return e(this.data().map(t))}catch(i){throw i}},(x.prototype=new y).createChange=function(t,e,i,n){this.changes.push({name:t,operation:e,obj:"U"!=e||this.disableDeltaChangesApi?JSON.parse(JSON.stringify(i)):this.getChangeDelta(i,n)})},x.prototype.insertMeta=function(t){var e,i;if(!this.disableMeta&&t)if(Array.isArray(t))for(e=t.length,i=0;i<e;i++)t[i].hasOwnProperty("meta")||(t[i].meta={}),t[i].meta.created=(new Date).getTime(),t[i].meta.revision=0;else t.meta||(t.meta={}),t.meta.created=(new Date).getTime(),t.meta.revision=0},x.prototype.updateMeta=function(t){!this.disableMeta&&t&&(t.meta.updated=(new Date).getTime(),t.meta.revision+=1)},x.prototype.createInsertChange=function(t){this.createChange(this.name,"I",t)},x.prototype.createUpdateChange=function(t,e){this.createChange(this.name,"U",t,e)},x.prototype.insertMetaWithChange=function(t){this.insertMeta(t),this.createInsertChange(t)},x.prototype.updateMetaWithChange=function(t,e){this.updateMeta(t),this.createUpdateChange(t,e)},x.prototype.lokiConsoleWrapper={log:function(){},warn:function(){},error:function(){}},x.prototype.addAutoUpdateObserver=function(t){this.autoupdate&&"function"==typeof Object.observe&&Object.observe(t,this.observerCallback,["add","update","delete","reconfigure","setPrototype"])},x.prototype.removeAutoUpdateObserver=function(t){this.autoupdate&&"function"==typeof Object.observe&&Object.unobserve(t,this.observerCallback)},x.prototype.addTransform=function(t,e){if(this.transforms.hasOwnProperty(t))throw new Error("a transform by that name already exists");this.transforms[t]=e},x.prototype.getTransform=function(t){return this.transforms[t]},x.prototype.setTransform=function(t,e){this.transforms[t]=e},x.prototype.removeTransform=function(t){delete this.transforms[t]},x.prototype.byExample=function(t){var e,i,n;for(e in n=[],t)t.hasOwnProperty(e)&&n.push(((i={})[e]=t[e],i));return{$and:n}},x.prototype.findObject=function(t){return this.findOne(this.byExample(t))},x.prototype.findObjects=function(t){return this.find(this.byExample(t))},x.prototype.ttlDaemonFuncGen=function(){var t=this,e=this.ttl.age;return function(){var i=Date.now();t.chain().where((function(t){return e<i-(t.meta.updated||t.meta.created)})).remove()}},x.prototype.setTTL=function(t,e){t<0?clearInterval(this.ttl.daemon):(this.ttl.age=t,this.ttl.ttlInterval=e,this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),e))},x.prototype.prepareFullDocIndex=function(){for(var t=this.data.length,e=new Array(t),i=0;i<t;i+=1)e[i]=i;return e},x.prototype.configureOptions=function(t){(t=t||{}).hasOwnProperty("adaptiveBinaryIndices")&&(this.adaptiveBinaryIndices=t.adaptiveBinaryIndices,this.adaptiveBinaryIndices&&this.ensureAllIndexes())},x.prototype.ensureIndex=function(t,i){if(void 0===i&&(i=!1),null==t)throw new Error("Attempting to set index without an associated property");if((!this.binaryIndices[t]||i||this.binaryIndices[t].dirty)&&(!0!==this.adaptiveBinaryIndices||!this.binaryIndices.hasOwnProperty(t)||i)){var r={name:t,dirty:!0,values:this.prepareFullDocIndex()};this.binaryIndices[t]=r;var s,o,a,l,u,c=(s=t,o=this.data,function(t,i){if(~s.indexOf(".")?(u=s.split("."),a=e.getIn(o[t],u,!0),l=e.getIn(o[i],u,!0)):(a=o[t][s],l=o[i][s]),a!==l){if(n.lt(a,l,!1))return-1;if(n.gt(a,l,!1))return 1}return 0});r.values.sort(c),r.dirty=!1,this.dirty=!0}},x.prototype.checkAllIndexes=function(e){var i,n=this.binaryIndices,r=[];for(i in n)t.call(n,i)&&(this.checkIndex(i,e)||r.push(i));return r},x.prototype.checkIndex=function(t,i){(i=i||{}).randomSamplingFactor&&!1!==i.randomSampling&&(i.randomSampling=!0),i.randomSamplingFactor=i.randomSamplingFactor||.1,(i.randomSamplingFactor<0||i.randomSamplingFactor>1)&&(i.randomSamplingFactor=.1);var n,r,s,o,a,l=!0;if(!this.binaryIndices.hasOwnProperty(t))throw new Error("called checkIndex on property without an index: "+t);if(this.adaptiveBinaryIndices||this.ensureIndex(t),(o=(a=this.binaryIndices[t].values).length)!==this.data.length)return i.repair&&this.ensureIndex(t,!0),!1;if(0===o)return!0;var u=-1!==t.indexOf(".");if(1===o)l=0===a[0];else if(i.randomSampling){if(h.$lte(e.getIn(this.data[a[0]],t,u),e.getIn(this.data[a[1]],t,u))||(l=!1),h.$lte(e.getIn(this.data[a[o-2]],t,u),e.getIn(this.data[a[o-1]],t,u))||(l=!1),l)for(r=Math.floor((o-1)*i.randomSamplingFactor),n=0;n<r-1;n++)if(s=Math.floor(Math.random()*(o-1)),!h.$lte(e.getIn(this.data[a[s]],t,u),e.getIn(this.data[a[s+1]],t,u))){l=!1;break}}else for(n=0;n<o-1;n++)if(!h.$lte(e.getIn(this.data[a[n]],t,u),e.getIn(this.data[a[n+1]],t,u))){l=!1;break}return!l&&i.repair&&this.ensureIndex(t,!0),l},x.prototype.getBinaryIndexValues=function(t){var i,n=this.binaryIndices[t].values,r=[];for(i=0;i<n.length;i++)r.push(e.getIn(this.data[n[i]],t,!0));return r},x.prototype.ensureUniqueIndex=function(t){var e=this.constraints.unique[t];return e||-1==this.uniqueNames.indexOf(t)&&this.uniqueNames.push(t),this.constraints.unique[t]=e=new q(t),this.data.forEach((function(t){e.set(t)})),e},x.prototype.ensureAllIndexes=function(e){var i,n=this.binaryIndices;for(i in n)t.call(n,i)&&this.ensureIndex(i,e)},x.prototype.flagBinaryIndexesDirty=function(){var e,i=this.binaryIndices;for(e in i)t.call(i,e)&&(i[e].dirty=!0)},x.prototype.flagBinaryIndexDirty=function(t){this.binaryIndices[t]&&(this.binaryIndices[t].dirty=!0)},x.prototype.count=function(t){return t?this.chain().find(t).filteredrows.length:this.data.length},x.prototype.ensureId=function(){var t=this.data.length,e=0;for(this.idIndex=[];e<t;e+=1)this.idIndex.push(this.data[e].$loki)},x.prototype.ensureIdAsync=function(t){this.async((function(){this.ensureId()}),t)},x.prototype.addDynamicView=function(t,e){var i=new O(this,t,e);return this.DynamicViews.push(i),i},x.prototype.removeDynamicView=function(t){this.DynamicViews=this.DynamicViews.filter((function(e){return e.name!==t}))},x.prototype.getDynamicView=function(t){for(var e=0;e<this.DynamicViews.length;e++)if(this.DynamicViews[e].name===t)return this.DynamicViews[e];return null},x.prototype.findAndUpdate=function(t,e){"function"==typeof t?this.updateWhere(t,e):this.chain().find(t).update(e)},x.prototype.findAndRemove=function(t){this.chain().find(t).remove()},x.prototype.insert=function(t){if(!Array.isArray(t))return this.insertOne(t);var e,i=[];this.emit("pre-insert",t);for(var n=0,r=t.length;n<r;n++){if(!(e=this.insertOne(t[n],!0)))return;i.push(e)}return this.emit("insert",i),1===(i=this.cloneObjects?p(i,this.cloneMethod):i).length?i[0]:i},x.prototype.insertOne=function(t,e){var i,n=null;if("object"!=typeof t?n=new TypeError("Document needs to be an object"):null===t&&(n=new TypeError("Object cannot be null")),null!==n)throw this.emit("error",n),n;var r=this.cloneObjects?p(t,this.cloneMethod):t;if(this.disableMeta||void 0!==r.meta||(r.meta={revision:0,created:0}),e||this.emit("pre-insert",r),this.add(r))return this.disableChangesApi?this.insertMeta(r):this.insertMetaWithChange(r),i=this.cloneObjects?p(r,this.cloneMethod):r,e||this.emit("insert",i),this.addAutoUpdateObserver(i),i},x.prototype.clear=function(t){var e=this;t=t||{},this.data=[],this.idIndex=[],this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[],this.dirty=!0,!0===t.removeIndices?(this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[]):(Object.keys(this.binaryIndices).forEach((function(t){e.binaryIndices[t].dirty=!1,e.binaryIndices[t].values=[]})),this.constraints={unique:{},exact:{}},this.uniqueNames.forEach((function(t){e.ensureUniqueIndex(t)})))},x.prototype.update=function(e){var i,n,r;if(Array.isArray(e)){r=e.length,(i=!this.cloneObjects&&this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0)&&(this.adaptiveBinaryIndices=!1);try{for(n=0;n<r;n+=1)this.update(e[n])}finally{i&&(this.ensureAllIndexes(),this.adaptiveBinaryIndices=!0)}}else{if(!t.call(e,"$loki"))throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()");try{this.startTransaction();var s,o,a,l,u,c=this.get(e.$loki,!0),h=this;if(!c)throw new Error("Trying to update a document not in collection.");s=c[0],a=c[1],o=this.cloneObjects||!this.disableDeltaChangesApi?p(e,this.cloneMethod):e,this.emit("pre-update",e),Object.keys(this.constraints.unique).forEach((function(t){h.constraints.unique[t].update(s,o)})),this.data[a]=o,o!==e&&this.addAutoUpdateObserver(e);for(var d=0;d<this.DynamicViews.length;d++)this.DynamicViews[d].evaluateDocument(a,!1);if(this.adaptiveBinaryIndices){var f=this.binaryIndices;for(l in f)this.adaptiveBinaryIndexUpdate(a,l)}else this.flagBinaryIndexesDirty();return this.idIndex[a]=o.$loki,this.isIncremental&&this.dirtyIds.push(o.$loki),this.commit(),this.dirty=!0,this.disableChangesApi?this.updateMeta(o,null):this.updateMetaWithChange(o,s),u=this.cloneObjects?p(o,this.cloneMethod):o,this.emit("update",u,s),u}catch(y){throw this.rollback(),this.lokiConsoleWrapper.error(y.message),this.emit("error",y),y}}},x.prototype.add=function(e){if("object"!=typeof e)throw new TypeError("Object being added needs to be an object");if(void 0!==e.$loki)throw new Error("Document is already in collection, please use update()");try{this.startTransaction(),this.maxId++,isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].$loki+1),e.$loki=this.maxId,this.disableMeta||(e.meta.version=0);var i,n=this.constraints.unique;for(i in n)t.call(n,i)&&n[i].set(e);this.idIndex.push(e.$loki),this.isIncremental&&this.dirtyIds.push(e.$loki),this.data.push(e);for(var r=this.data.length-1,s=this.DynamicViews.length,o=0;o<s;o++)this.DynamicViews[o].evaluateDocument(r,!0);if(this.adaptiveBinaryIndices){var a=this.binaryIndices;for(i in a)this.adaptiveBinaryIndexInsert(r,i)}else this.flagBinaryIndexesDirty();return this.commit(),this.dirty=!0,this.cloneObjects?p(e,this.cloneMethod):e}catch(l){throw this.rollback(),this.lokiConsoleWrapper.error(l.message),this.emit("error",l),l}},x.prototype.updateWhere=function(t,e){var i,n=this.where(t),r=0;try{for(;r<n.length;r++)i=e(n[r]),this.update(i)}catch(s){this.rollback(),this.lokiConsoleWrapper.error(s.message)}},x.prototype.removeWhere=function(t){var e;"function"==typeof t?(e=this.data.filter(t),this.remove(e)):this.chain().find(t).remove()},x.prototype.removeDataOnly=function(){this.remove(this.data.slice())},x.prototype.removeBatchByPositions=function(t){var e,i,n,r,s=t.length,o={},a=Object.keys(this.binaryIndices).length,l=Object.keys(this.constraints.unique).length,u=this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0,c=this;try{for(this.startTransaction(),n=0;n<s;n++)o[this.idIndex[t[n]]]=!0;if((e=this.DynamicViews.length)>0||a>0||l>0){if(e>0)for(i=0;i<e;i++)this.DynamicViews[i].removeDocument(t);if(this.adaptiveBinaryIndices&&!u){var h,d=this.binaryIndices;for(h in d)this.adaptiveBinaryIndexRemove(t,h)}else this.flagBinaryIndexesDirty();l&&Object.keys(this.constraints.unique).forEach((function(e){for(n=0;n<s;n++)null!=(r=c.data[t[n]])[e]&&c.constraints.unique[e].remove(r[e])}))}if(!this.disableChangesApi||this.events.delete.length>1)for(n=0;n<s;n++)this.emit("delete",this.data[t[n]]);this.data=this.data.filter((function(t){return!o[t.$loki]})),this.idIndex=this.idIndex.filter((function(t){return!o[t]})),this.adaptiveBinaryIndices&&u&&(this.adaptiveBinaryIndices=!1,this.ensureAllIndexes(!0),this.adaptiveBinaryIndices=!0),this.commit(),this.dirty=!0}catch(p){return this.rollback(),u&&(this.adaptiveBinaryIndices=!0),this.lokiConsoleWrapper.error(p.message),this.emit("error",p),null}},x.prototype.removeBatch=function(t){var e,i=t.length,n=this.data.length,r={},s=[];for(e=0;e<n;e++)r[this.data[e].$loki]=e;for(e=0;e<i;e++)s.push("object"==typeof t[e]?r[t[e].$loki]:r[t[e]]);this.removeBatchByPositions(s)},x.prototype.remove=function(e){if("number"==typeof e&&(e=this.get(e)),"object"!=typeof e)throw new Error("Parameter is not an object");if(Array.isArray(e))this.removeBatch(e);else{if(!t.call(e,"$loki"))throw new Error("Object is not a document stored in the collection");try{this.startTransaction();var i=this.get(e.$loki,!0),n=i[1],r=this;Object.keys(this.constraints.unique).forEach((function(t){null!=e[t]&&r.constraints.unique[t].remove(e[t])}));for(var s=0;s<this.DynamicViews.length;s++)this.DynamicViews[s].removeDocument(n);if(this.adaptiveBinaryIndices){var o,a=this.binaryIndices;for(o in a)this.adaptiveBinaryIndexRemove(n,o)}else this.flagBinaryIndexesDirty();return this.data.splice(n,1),this.removeAutoUpdateObserver(e),this.idIndex.splice(n,1),this.isIncremental&&this.dirtyIds.push(e.$loki),this.commit(),this.dirty=!0,this.emit("delete",i[0]),delete e.$loki,delete e.meta,e}catch(l){return this.rollback(),this.lokiConsoleWrapper.error(l.message),this.emit("error",l),null}}},x.prototype.get=function(t,e){var i=e||!1,n=this.idIndex,r=n.length-1,s=0,o=s+r>>1;if(t="number"==typeof t?t:parseInt(t,10),isNaN(t))throw new TypeError("Passed id is not an integer");for(;n[s]<n[r];)n[o=s+r>>1]<t?s=o+1:r=o;return r===s&&n[s]===t?i?[this.data[s],s]:this.data[s]:null},x.prototype.getBinaryIndexPosition=function(t,i){var n=e.getIn(this.data[t],i,!0),r=this.binaryIndices[i].values,s=this.calculateRange("$eq",i,n);if(0===s[0]&&-1===s[1])return null;for(var o=s[1],a=s[0];a<=o;a++)if(r[a]===t)return a;return null},x.prototype.adaptiveBinaryIndexInsert=function(t,i){var n=-1!==i.indexOf("."),r=this.binaryIndices[i].values,s=e.getIn(this.data[t],i,n);!0===this.serializableIndices&&s instanceof Date&&(this.data[t][i]=s.getTime(),s=e.getIn(this.data[t],i));var o=0===r.length?0:this.calculateRangeStart(i,s,!0,n);this.binaryIndices[i].values.splice(o,0,t)},x.prototype.adaptiveBinaryIndexUpdate=function(t,e){var i,n=this.binaryIndices[e].values,r=n.length;for(i=0;i<r&&n[i]!==t;i++);this.binaryIndices[e].values.splice(i,1),this.adaptiveBinaryIndexInsert(t,e)},x.prototype.adaptiveBinaryIndexRemove=function(t,e,i){var n,r,s,o,a,l,u,c=this.binaryIndices[e],h={};if(Array.isArray(t)){if(1!==(o=t.length)){for(s=0;s<o;s++)h[t[s]]=!0;if(c.values=c.values.filter((function(t){return!h[t]})),!0===i)return;var d=t.slice();for(d.sort((function(t,e){return t-e})),n=c.values.length,r=0;r<n;r++){for(a=c.values[r],l=0,s=0;s<o&&a>d[s];s++)l++;c.values[r]-=l}return}t=t[0]}if(null===(u=this.getBinaryIndexPosition(t,e)))return null;if(c.values.splice(u,1),!0!==i)for(n=c.values.length,r=0;r<n;r++)c.values[r]>t&&c.values[r]--},x.prototype.calculateRangeStart=function(t,i,r,s){var o=this.data,a=this.binaryIndices[t].values,l=0,u=a.length-1,c=0;if(0===a.length)return-1;for(e.getIn(o[a[l]],t,s),e.getIn(o[a[u]],t,s);l<u;)n.lt(e.getIn(o[a[c=l+u>>1]],t,s),i,!1)?l=c+1:u=c;var h=l;return n.aeq(i,e.getIn(o[a[h]],t,s))?h:n.lt(i,e.getIn(o[a[h]],t,s),!1)?r?h:h-1:r?h+1:h},x.prototype.calculateRangeEnd=function(t,i,r){var s=this.data,o=this.binaryIndices[t].values,a=0,l=o.length-1,u=0;if(0===o.length)return-1;for(e.getIn(s[o[a]],t,r),e.getIn(s[o[l]],t,r);a<l;)n.lt(i,e.getIn(s[o[u=a+l>>1]],t,r),!1)?l=u:a=u+1;var c=l;return n.aeq(i,e.getIn(s[o[c]],t,r))?c:n.gt(i,e.getIn(s[o[c]],t,r),!1)?c+1:n.aeq(i,e.getIn(s[o[c-1]],t,r))?c-1:c},x.prototype.calculateRange=function(t,i,r){var s,o,a,l=this.data,u=this.binaryIndices[i].values,c=u.length-1;if(0===l.length)return[0,-1];var h=-1!==i.indexOf("."),d=e.getIn(l[u[0]],i,h),p=e.getIn(l[u[c]],i,h);switch(t){case"$eq":case"$aeq":case"$dteq":if(n.lt(r,d,!1)||n.gt(r,p,!1))return[0,-1];break;case"$gt":if(n.gt(r,p,!0))return[0,-1];if(n.gt(d,r,!1))return[0,c];break;case"$gte":if(n.gt(r,p,!1))return[0,-1];if(n.gt(d,r,!0))return[0,c];break;case"$lt":if(n.lt(r,d,!0))return[0,-1];if(n.lt(p,r,!1))return[0,c];break;case"$lte":if(n.lt(r,d,!1))return[0,-1];if(n.lt(p,r,!0))return[0,c];break;case"$between":return n.gt(r[0],p,!1)?[0,-1]:n.lt(r[1],d,!1)?[0,-1]:((s=this.calculateRangeStart(i,r[0],!1,h))<0&&s++,(a=this.calculateRangeEnd(i,r[1],h))>c&&a--,n.gt(e.getIn(l[u[s]],i,h),r[0],!0)||s++,n.lt(e.getIn(l[u[a]],i,h),r[1],!0)||a--,a<s?[0,-1]:[s,a]);case"$in":for(var f=[],y=[],v=0,g=r.length;v<g;v++)for(var b=this.calculateRange("$eq",i,r[v]),m=b[0];m<=b[1];m++)void 0===f[m]&&(f[m]=!0,y.push(m));return y}switch(t){case"$eq":case"$aeq":case"$dteq":case"$gte":case"$lt":s=this.calculateRangeStart(i,r,!1,h),o=e.getIn(l[u[s]],i,h)}switch(t){case"$eq":case"$aeq":case"$dteq":case"$lte":case"$gt":a=this.calculateRangeEnd(i,r,h),e.getIn(l[u[a]],i,h)}switch(t){case"$eq":case"$aeq":case"$dteq":return n.aeq(o,r)?[s,a]:[0,-1];case"$gt":return n.aeq(e.getIn(l[u[a]],i,h),r)?[a+1,c]:[a,c];case"$gte":return n.aeq(e.getIn(l[u[s]],i,h),r)?[s,c]:[s+1,c];case"$lt":return n.aeq(e.getIn(l[u[s]],i,h),r)?[0,s-1]:[0,s];case"$lte":return n.aeq(e.getIn(l[u[a]],i,h),r)?[0,a]:[0,a-1];default:return[0,l.length-1]}},x.prototype.by=function(t,e){var i;if(void 0===e)return i=this,function(e){return i.by(t,e)};var n=this.constraints.unique[t].get(e);return this.cloneObjects?p(n,this.cloneMethod):n},x.prototype.findOne=function(t){t=t||{};var e=this.chain().find(t,!0).data();return Array.isArray(e)&&0===e.length?null:this.cloneObjects?p(e[0],this.cloneMethod):e[0]},x.prototype.chain=function(t,e){var i=new I(this);return void 0===t?i:i.transform(t,e)},x.prototype.find=function(t){return this.chain().find(t).data()},x.prototype.findOneUnindexed=function(t,i){for(var n=this.data.length;n--;)if(e.getIn(this.data[n],t,!0)===i)return this.data[n];return null},x.prototype.startTransaction=function(){if(this.transactional){this.cachedData=p(this.data,this.cloneMethod),this.cachedIndex=this.idIndex,this.cachedBinaryIndex=this.binaryIndices,this.cachedDirtyIds=this.dirtyIds;for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].startTransaction()}},x.prototype.commit=function(){if(this.transactional){this.cachedData=null,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedDirtyIds=null;for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].commit()}},x.prototype.rollback=function(){if(this.transactional){null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=this.cachedBinaryIndex,this.dirtyIds=this.cachedDirtyIds);for(var t=0;t<this.DynamicViews.length;t++)this.DynamicViews[t].rollback()}},x.prototype.async=function(t,e){setTimeout((function(){if("function"!=typeof t)throw new TypeError("Argument passed for async execution is not a function");t(),e()}),0)},x.prototype.where=function(t){return this.chain().where(t).data()},x.prototype.mapReduce=function(t,e){try{return e(this.data.map(t))}catch(i){throw i}},x.prototype.eqJoin=function(t,e,i,n,r){return new I(this).eqJoin(t,e,i,n,r)},x.prototype.stages={},x.prototype.getStage=function(t){return this.stages[t]||(this.stages[t]={}),this.stages[t]},x.prototype.commitLog=[],x.prototype.stage=function(t,e){var i=JSON.parse(JSON.stringify(e));return this.getStage(t)[e.$loki]=i,i},x.prototype.commitStage=function(t,e){var i,n=this.getStage(t),r=(new Date).getTime();for(i in n)this.update(n[i]),this.commitLog.push({timestamp:r,message:e,data:JSON.parse(JSON.stringify(n[i]))});this.stages[t]={}},x.prototype.no_op=function(){},x.prototype.extract=function(t){for(var e=0,i=this.data.length,n=k(t),r=[];e<i;e+=1)r.push(P(this.data[e],t,n));return r},x.prototype.max=function(t){return Math.max.apply(null,this.extract(t))},x.prototype.min=function(t){return Math.min.apply(null,this.extract(t))},x.prototype.maxRecord=function(t){for(var e,i=0,n=this.data.length,r=k(t),s={index:0,value:void 0};i<n;i+=1)void 0!==e?e<P(this.data[i],t,r)&&(e=P(this.data[i],t,r),s.index=this.data[i].$loki):(e=P(this.data[i],t,r),s.index=this.data[i].$loki);return s.value=e,s},x.prototype.minRecord=function(t){for(var e,i=0,n=this.data.length,r=k(t),s={index:0,value:void 0};i<n;i+=1)void 0!==e?e>P(this.data[i],t,r)&&(e=P(this.data[i],t,r),s.index=this.data[i].$loki):(e=P(this.data[i],t,r),s.index=this.data[i].$loki);return s.value=e,s},x.prototype.extractNumerical=function(t){return this.extract(t).map(A).filter(Number).filter((function(t){return!isNaN(t)}))},x.prototype.avg=function(t){return S(this.extractNumerical(t))},x.prototype.stdDev=function(t){return e=this.extractNumerical(t),i=S(e),n=S(e.map((function(t){var e=t-i;return e*e}))),Math.sqrt(n);var e,i,n},x.prototype.mode=function(t){var e,i,n,r={},s=this.extract(t);for(i in s.forEach((function(t){r[t]?r[t]+=1:r[t]=1})),r)e?e<r[i]&&(n=i):(n=i,e=r[i]);return n},x.prototype.median=function(t){var e=this.extractNumerical(t);e.sort(C);var i=Math.floor(e.length/2);return e.length%2?e[i]:(e[i-1]+e[i])/2},$.prototype={keys:[],values:[],sort:function(t,e){return t<e?-1:t>e?1:0},setSort:function(t){this.bs=new j(t)},bs:function(){return new j(this.sort)},set:function(t,e){var i=this.bs(this.keys,t);i.found?this.values[i.index]=e:(this.keys.splice(i.index,0,t),this.values.splice(i.index,0,e))},get:function(t){return this.values[N(this.keys,t,this.sort).index]}},q.prototype.keyMap={},q.prototype.lokiMap={},q.prototype.set=function(t){var e=t[this.field];if(null!=e){if(this.keyMap[e])throw new Error("Duplicate key for property "+this.field+": "+e);this.keyMap[e]=t,this.lokiMap[t.$loki]=e}},q.prototype.get=function(t){return this.keyMap[t]},q.prototype.byId=function(t){return this.keyMap[this.lokiMap[t]]},q.prototype.update=function(t,e){if(this.lokiMap[t.$loki]!==e[this.field]){var i=this.lokiMap[t.$loki];this.set(e),this.keyMap[i]=void 0}else this.keyMap[t[this.field]]=e},q.prototype.remove=function(t){var e=this.keyMap[t];if(null==e)throw new Error("Key is not in unique index: "+this.field);this.keyMap[t]=void 0,this.lokiMap[e.$loki]=void 0},q.prototype.clear=function(){this.keyMap={},this.lokiMap={}},E.prototype={set:function(t,e){this.index[t]?this.index[t].push(e):this.index[t]=[e]},remove:function(t,e){var i=this.index[t];for(var n in i)i[n]==e&&i.splice(n,1);i.length<1&&(this.index[t]=void 0)},get:function(t){return this.index[t]},clear:function(t){this.index={}}},v.LokiOps=h,v.Collection=x,v.KeyValueStore=$,v.LokiMemoryAdapter=g,v.LokiPartitioningAdapter=b,v.LokiLocalStorageAdapter=w,v.LokiFsAdapter=m,v.persistenceAdapters={fs:m,localStorage:w},v.aeq=r,v.lt=s,v.gt=o,v.Comparators=n,v}()})?n.apply(e,[]):n)||(t.exports=r)},pnzC:function(t,e,i){var n,r;void 0===(r="function"==typeof(n=function(){return function(){function t(t,e){if(this.app="loki",this.options=e||{},void 0!==t&&(this.app=t),this.catalog=null,!this.checkAvailability())throw new Error("indexedDB does not seem to be supported for your environment")}function e(t){this.db=null,this.initializeLokiCatalog(t)}return t.prototype.closeDatabase=function(){this.catalog&&this.catalog.db&&(this.catalog.db.close(),this.catalog.db=null)},t.prototype.checkAvailability=function(){return!("undefined"==typeof indexedDB||!indexedDB)},t.prototype.loadKey=t.prototype.loadDatabase=function(t,i){var n=this;null!==this.catalog&&null!==this.catalog.db?this.catalog.getAppKey(this.app,t,(function(t){if("function"==typeof i){if(0===t.id)return void i(null);i(t.val)}else console.log(t.val)})):this.catalog=new e((function(e){n.catalog=e,n.loadDatabase(t,i)}))},t.prototype.saveKey=t.prototype.saveDatabase=function(t,i,n){var r=this;function s(t){n(t&&!0===t.success?null:new Error("Error saving database")),r.options.closeAfterSave&&r.closeDatabase()}null!==this.catalog&&null!==this.catalog.db?this.catalog.setAppKey(this.app,t,i,s):this.catalog=new e((function(e){r.saveDatabase(t,i,s)}))},t.prototype.deleteKey=t.prototype.deleteDatabase=function(t,i){var n=this;null!==this.catalog&&null!==this.catalog.db?this.catalog.getAppKey(this.app,t,(function(t){var e=t.id;0!==e?n.catalog.deleteAppKey(e,i):"function"==typeof i&&i({success:!0})})):this.catalog=new e((function(e){n.catalog=e,n.deleteDatabase(t,i)}))},t.prototype.deleteDatabasePartitions=function(t){var e=this;this.getDatabaseList((function(i){i.forEach((function(i){i.startsWith(t)&&e.deleteDatabase(i)}))}))},t.prototype.getKeyList=t.prototype.getDatabaseList=function(t){var i=this;null!==this.catalog&&null!==this.catalog.db?this.catalog.getAppKeys(this.app,(function(e){for(var i=[],n=0;n<e.length;n++)i.push(e[n].key);"function"==typeof t?t(i):i.forEach((function(t){console.log(t)}))})):this.catalog=new e((function(e){i.catalog=e,i.getDatabaseList(t)}))},t.prototype.getCatalogSummary=function(t){var i=this;null!==this.catalog&&null!==this.catalog.db?this.catalog.getAllKeys((function(e){for(var i,n=[],r=0;r<e.length;r++)n.push({app:(i=e[r]).app,key:i.key,size:2*(i.app||"").length+2*(i.key||"").length+(i.val||"").length+1});"function"==typeof t?t(n):n.forEach((function(t){console.log(t)}))})):this.catalog=new e((function(e){i.catalog=e,i.getCatalogSummary(t)}))},e.prototype.initializeLokiCatalog=function(t){var e=indexedDB.open("LokiCatalog",1),i=this;e.onupgradeneeded=function(t){var e=t.target.result;if(e.objectStoreNames.contains("LokiAKV")&&e.deleteObjectStore("LokiAKV"),!e.objectStoreNames.contains("LokiAKV")){var i=e.createObjectStore("LokiAKV",{keyPath:"id",autoIncrement:!0});i.createIndex("app","app",{unique:!1}),i.createIndex("key","key",{unique:!1}),i.createIndex("appkey","appkey",{unique:!0})}},e.onsuccess=function(e){i.db=e.target.result,"function"==typeof t&&t(i)},e.onerror=function(t){throw t}},e.prototype.getAppKey=function(t,e,i){var n,r=this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").index("appkey").get(t+","+e);r.onsuccess=(n=i,function(t){var e=t.target.result;null==e&&(e={id:0,success:!1}),"function"==typeof n?n(e):console.log(e)}),r.onerror=function(t){return function(e){if("function"!=typeof t)throw e;t({id:0,success:!1})}}(i)},e.prototype.getAppKeyById=function(t,e,i){this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").get(t).onsuccess=function(t,e){return function(i){"function"==typeof e?e(i.target.result,t):console.log(i.target.result)}}(i,e)},e.prototype.setAppKey=function(t,e,i,n){var r,s=this.db.transaction(["LokiAKV"],"readwrite").objectStore("LokiAKV"),o=s.index("appkey").get(t+","+e);o.onsuccess=function(r){var a=r.target.result;null==a?a={app:t,key:e,appkey:t+","+e,val:i}:a.val=i;var l,u=s.put(a);u.onerror=(l=n,function(t){"function"==typeof l?l({success:!1}):(console.error("LokiCatalog.setAppKey (set) onerror"),console.error(o.error))}),u.onsuccess=function(t){return function(e){"function"==typeof t&&t({success:!0})}}(n)},o.onerror=(r=n,function(t){"function"==typeof r?r({success:!1}):(console.error("LokiCatalog.setAppKey (get) onerror"),console.error(o.error))})},e.prototype.deleteAppKey=function(t,e){var i,n=this.db.transaction(["LokiAKV"],"readwrite").objectStore("LokiAKV").delete(t);n.onsuccess=(i=e,function(t){"function"==typeof i&&i({success:!0})}),n.onerror=function(t){return function(e){"function"==typeof t?t({success:!1}):(console.error("LokiCatalog.deleteAppKey raised onerror"),console.error(n.error))}}(e)},e.prototype.getAppKeys=function(t,e){var i,n=this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").index("app"),r=IDBKeyRange.only(t),s=n.openCursor(r);s.onsuccess=function(t,e){return function(i){var n=i.target.result;n?(t.push(n.value),n.continue()):"function"==typeof e?e(t):console.log(t)}}([],e),s.onerror=(i=e,function(t){"function"==typeof i?i(null):(console.error("LokiCatalog.getAppKeys raised onerror"),console.error(t))})},e.prototype.getAllKeys=function(t){var e,i=this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").openCursor();i.onsuccess=function(t,e){return function(i){var n=i.target.result;n?(t.push(n.value),n.continue()):"function"==typeof e?e(t):console.log(t)}}([],t),i.onerror=(e=t,function(t){"function"==typeof e&&e(null)})},t}()})?n.apply(e,[]):n)||(t.exports=r)},xDdU:function(t,e,i){var n,r,s=i("4fRq"),o=i("I2ZF"),a=0,l=0;t.exports=function(t,e,i){var u=e&&i||0,c=e||[],h=(t=t||{}).node||n,d=void 0!==t.clockseq?t.clockseq:r;if(null==h||null==d){var p=s();null==h&&(h=n=[1|p[0],p[1],p[2],p[3],p[4],p[5]]),null==d&&(d=r=16383&(p[6]<<8|p[7]))}var f=void 0!==t.msecs?t.msecs:(new Date).getTime(),y=void 0!==t.nsecs?t.nsecs:l+1,v=f-a+(y-l)/1e4;if(v<0&&void 0===t.clockseq&&(d=d+1&16383),(v<0||f>a)&&void 0===t.nsecs&&(y=0),y>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");a=f,l=y,r=d;var g=(1e4*(268435455&(f+=122192928e5))+y)%4294967296;c[u++]=g>>>24&255,c[u++]=g>>>16&255,c[u++]=g>>>8&255,c[u++]=255&g;var b=f/4294967296*1e4&268435455;c[u++]=b>>>8&255,c[u++]=255&b,c[u++]=b>>>24&15|16,c[u++]=b>>>16&255,c[u++]=d>>>8|128,c[u++]=255&d;for(var m=0;m<6;++m)c[u+m]=h[m];return e||o(c)}},xk4V:function(t,e,i){var n=i("4fRq"),r=i("I2ZF");t.exports=function(t,e,i){var s=e&&i||0;"string"==typeof t&&(e="binary"===t?new Array(16):null,t=null);var o=(t=t||{}).random||(t.rng||n)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,e)for(var a=0;a<16;++a)e[s+a]=o[a];return e||r(o)}}}]);